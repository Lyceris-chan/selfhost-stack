<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZimaOS $APP_NAME</title>
    <link rel="icon" type="image/svg+xml" href="/assets/$APP_NAME.svg">
    <!-- Local privacy friendly assets (Hosted Locally) -->
    <link href="assets/gs.css" rel="stylesheet">
    <link href="assets/cc.css" rel="stylesheet">
    <link href="assets/ms.css" rel="stylesheet">
    <script>
        // HTTPS Auto-Switch & Default Logic
        const isLocalHost = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1');
        const isIpHost = window.location.hostname.match(/^\d+\.\d+\.\d+\.\d+$/);
        
        // Storage reset logic for -c cleanup
        if (window.location.search.includes('reset=true')) {
            localStorage.clear();
            sessionStorage.clear();
            const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);
        }

        if (window.location.protocol === 'http:' && !isLocalHost && !isIpHost) {
            const httpsPort = '8443';
            const httpsUrl = 'https://' + window.location.hostname + ':' + httpsPort + window.location.pathname + window.location.search;
            // Only redirect if we're not on a standard port or if specifically requested
            // Use a small delay to ensure page load doesnt flicker
            setTimeout(() => {
                fetch(httpsUrl, { mode: 'no-cors' }).then(() => {
                    window.location.href = httpsUrl;
                }).catch(() => {
                    console.log("HTTPS port not reachable, staying on HTTP");
                });
            }, 500);
        }
        
        // Prevent extension injection errors - defined early
        globalThis.configureInjection = globalThis.configureInjection || (() => {});
    </script>
    <script type="module">
        import * as MaterialColorUtilities from './assets/mcu.js';
        window.MaterialColorUtilities = MaterialColorUtilities;
    </script>
    <style>
{{DHI_CSS}}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-row">
                <div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <h1>Privacy Hub</h1>
                        <div class="slot-badge" data-tooltip="Active System Slot (A/B Update System)">Slot ${CURRENT_SLOT}</div>
                    </div>
                    <div class="subtitle">Self-hosted network security and private service infrastructure.</div>
                </div>
                <div class="header-actions">
                    <div id="https-badge" class="chip vpn" style="gap:4px; display:none; height: 32px; padding: 0 12px; border-radius: 16px;" data-tooltip="Connection is secured with end-to-end encryption.">
                        <span class="material-symbols-rounded" style="font-size:18px;">lock</span>
                        <span style="font-size: 12px; font-weight: 600;">Secure HTTPS</span>
                    </div>
                    <div class="switch-container" id="privacy-switch" onclick="togglePrivacy()" data-tooltip="Redact identifying metrics for privacy">
                        <span class="label-large">Safe Display Mode</span>
                        <div class="switch-track">
                            <div class="switch-thumb"></div>
                        </div>
                    </div>
                    <div class="status-indicator" style="background: var(--md-sys-color-surface-container-high); border: 1px solid var(--md-sys-color-outline-variant);">
                        <span class="status-dot" id="api-dot"></span>
                        <span class="status-text" id="api-text">Connecting to API...</span>
                    </div>
                    <div class="theme-toggle" onclick="toggleTheme()" data-tooltip="Switch between Light and Dark mode">
                        <span class="material-symbols-rounded" id="theme-icon">light_mode</span>
                    </div>
                    <div class="theme-toggle" id="admin-lock-btn" onclick="toggleAdminMode()" data-tooltip="Enter Admin Mode to manage services">
                        <span class="material-symbols-rounded" id="admin-icon">admin_panel_settings</span>
                    </div>
                </div>
            </div>
        </header>

        <div class="filter-bar" id="category-filters">
            <div class="chip filter-chip active" data-target="all" onclick="filterCategory('all')">All Services</div>
            <div class="chip filter-chip" data-target="apps" onclick="filterCategory('apps')">Applications</div>
            <div class="chip filter-chip" data-target="system" onclick="filterCategory('system')">Infrastructure</div>
            <div class="chip filter-chip" data-target="dns" onclick="filterCategory('dns')">DNS & Security</div>
            <div class="chip filter-chip" data-target="tools" onclick="filterCategory('tools')">Utilities</div>
            <div class="chip filter-chip admin-only" data-target="logs" onclick="filterCategory('logs')">System Logs</div>
        </div>

        <div id="update-banner" class="admin-only" style="display:none; margin-bottom: 32px;">
            <div class="card" style="min-height: auto; padding: 24px; background: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container);">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 24px; flex-wrap: wrap;">
                    <div>
                        <h3 style="margin:0; color: inherit;">Updates Available</h3>
                        <p class="body-medium" id="update-list" style="margin: 8px 0 0 0; color: inherit; opacity: 0.9;">New versions detected for some services.</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="updateAllServices()" class="btn btn-filled" style="background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary);" data-tooltip="Pull latest source code and rebuild containers for all pending services.">Update All</button>
                        <button onclick="dismissUpdateBanner()" class="btn btn-outlined" style="border-color: currentColor; color: inherit;">Dismiss</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="mac-advisory" style="margin-bottom: 32px;">
            <div class="card" style="min-height: auto; padding: 16px 24px; background: var(--md-sys-color-error-container); color: var(--md-sys-color-on-error-container);">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 24px;">
                    <div style="display: flex; gap: 16px; align-items: flex-start;">
                        <span class="material-symbols-rounded" style="margin-top: 2px;">warning</span>
                        <div>
                            <h3 style="margin:0; color: inherit; font-size: 16px;">Critical Network Advisory</h3>
                            <p class="body-medium" style="margin: 4px 0 0 0; color: inherit; opacity: 0.9;">
                                To ensure firewall persistence and static IP reliability, you <strong>must disable Dynamic/Random MAC addresses</strong> in your host device's network settings.
                            </p>
                        </div>
                    </div>
                    <button onclick="dismissMacAdvisory()" class="btn btn-icon" style="color: inherit; margin: -8px -8px 0 0;" data-tooltip="Dismiss">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
            </div>
        </div>



        <section data-category="apps">
        <div class="section-label">Applications</div>
        <div class="section-hint" style="display: flex; gap: 8px; flex-wrap: wrap;">
            <span class="chip category-badge" data-tooltip="Services isolated within a secure VPN tunnel (Gluetun). This allows you to host your own private instances—removing the need to trust third-party hosts—while ensuring your home IP remains hidden from end-service providers."><span class="material-symbols-rounded">vpn_lock</span> VPN Protected</span>
            <span class="chip category-badge" data-tooltip="Local services accessed directly through the internal network interface."><span class="material-symbols-rounded">lan</span> Direct Access</span>
            <span class="chip category-badge" data-tooltip="Advanced infrastructure control and container telemetry via Portainer."><span class="material-symbols-rounded">hub</span> Infrastructure</span>
        </div>
        <div id="grid-apps" class="grid">
            <!-- Dynamic Cards Injected Here -->
        </div>
        </section>

        <section data-category="system">
        <div class="section-label">System Management</div>
        <div class="section-hint" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
            <span class="chip category-badge" style="background: var(--md-sys-color-surface-container-highest);"><span class="material-symbols-rounded">settings_input_component</span> System Core</span>
        </div>
        
        <div class="section-hint" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; border: 1px solid var(--md-sys-color-outline-variant); padding: 16px; border-radius: 16px;">
            <div style="width: 100%; display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: var(--md-sys-color-primary);">
                <span class="material-symbols-rounded" style="font-size: 20px;">vpn_lock</span>
                <span class="label-large" style="font-weight: 600;">Outbound VPN Gateway (Gluetun)</span>
            </div>
            <span class="chip category-badge" id="hint-vpn-status" data-tooltip="Gluetun Outbound VPN Tunnel Status">VPN: Checking...</span>
            <span class="chip category-badge" id="hint-vpn-ip" data-tooltip="Current Public VPN IP"><span class="material-symbols-rounded" style="font-size:14px;">public</span> IP: --</span>
            <span class="chip category-badge" id="hint-vpn-speed" data-tooltip="Real-time VPN Throughput"><span class="material-symbols-rounded" style="font-size:14px;">speed</span> --</span>
            <span class="chip category-badge" id="hint-vpn-usage" data-tooltip="VPN Session / Total Data Usage"><span class="material-symbols-rounded" style="font-size:14px;">data_usage</span> --</span>
        </div>

        <div class="section-hint" style="display: flex; gap: 8px; flex-wrap: wrap; border: 1px solid var(--md-sys-color-outline-variant); padding: 16px; border-radius: 16px;">
            <div style="width: 100%; display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: var(--md-sys-color-primary);">
                <span class="material-symbols-rounded" style="font-size: 20px;">settings_input_antenna</span>
                <span class="label-large" style="font-weight: 600;">Inbound Access Gateway (WireGuard)</span>
            </div>
            <span class="chip category-badge" id="hint-wge-clients" data-tooltip="WG-Easy Active/Total Clients"><span class="material-symbols-rounded" style="font-size:14px;">group</span> -- Clients</span>
            <span class="chip category-badge" id="hint-wge-usage" data-tooltip="WG-Easy Inbound Data Usage (Session / Total)"><span class="material-symbols-rounded" style="font-size:14px;">move_up</span> --</span>
        </div>
        <div id="grid-system" class="grid">
            <!-- Dynamic Cards Injected Here -->
        </div>
        </section>

        <section data-category="dns">
        <div class="section-label">DNS Configuration</div>
        <div class="grid">
            <div class="card">
                <h3>Certificate Status</h3>
                <div id="cert-status-content" style="padding-top: 12px; flex-grow: 1;">
                    <div class="stat-row" data-tooltip="Type of SSL certificate currently installed"><span class="stat-label">Type</span><span class="stat-value" id="cert-type">Checking...</span></div>
                    <div class="stat-row" data-tooltip="The domain name this certificate protects"><span class="stat-label">Domain</span><span class="stat-value sensitive" id="cert-subject">Checking...</span></div>
                    <div class="stat-row" data-tooltip="The authority that issued this certificate"><span class="stat-label">Issuer</span><span class="stat-value sensitive" id="cert-issuer">Checking...</span></div>
                    <div class="stat-row" data-tooltip="Date when this certificate will expire"><span class="stat-label">Expires</span><span class="stat-value sensitive" id="cert-to">Checking...</span></div>
                    <div id="ssl-failure-info" style="display:none; margin-top: 16px; padding: 16px; border-radius: var(--md-sys-shape-corner-medium); background: var(--md-sys-color-error-container); color: var(--md-sys-color-on-error-container); border: 1px solid var(--md-sys-color-error);">
                        <div class="body-small" style="font-weight:600; margin-bottom:4px; display: flex; align-items: center; gap: 8px;">
                            <span class="material-symbols-rounded" style="font-size: 16px;">error</span>
                            Pipeline Error
                        </div>
                        <div class="body-small" id="ssl-failure-reason" style="opacity: 0.9;">--</div>
                    </div>
                    <div id="cert-loading" class="chip admin" style="width: 100%; justify-content: flex-start; gap: 12px; height: auto; padding: 12px; border-radius: var(--md-sys-shape-corner-medium); border: none; margin-top: 16px;">
                        <div style="width: 24px; height: 24px; border: 3px solid var(--md-sys-color-on-secondary-container); border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <div style="display: flex; flex-direction: column; gap: 2px;">
                            <span style="font-weight: 600;">Verifying Pipeline</span>
                            <span class="body-medium" style="opacity: 0.8; white-space: normal;">Checking SSL certificate validity and issuance status...</span>
                        </div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 24px; gap: 16px; flex-wrap: wrap;">
                    <div id="cert-status-badge" class="chip" style="width: fit-content;" data-tooltip="Overall health of the SSL certificate issuance pipeline">Not Installed</div>
                    <button id="ssl-retry-btn" class="btn btn-icon btn-action" style="display:none;" data-tooltip="Force Let's Encrypt re-attempt" onclick="requestSslCheck()">
                        <span class="material-symbols-rounded">refresh</span>
                    </button>
                </div>
            </div>
            <div class="card admin-only">
                <h3>deSEC Configuration</h3>
                <p class="body-medium description">Manage your dynamic DNS and SSL certificate parameters:</p>
                <form onsubmit="saveDesecConfig(); return false;">
                    <input type="text" id="desec-domain-input" class="text-field" placeholder="Domain (e.g. yourname.dedyn.io)" style="margin-bottom:12px;" autocomplete="username" data-tooltip="Enter your registered deSEC domain (e.g. yourname.dedyn.io). You can create one for free at desec.io.">
                    <input type="password" id="desec-token-input" class="text-field sensitive" placeholder="deSEC API Token" style="margin-bottom:12px;" autocomplete="current-password" data-tooltip="The secret API token from your deSEC account used to verify domain ownership.">
                    <p class="body-small" style="margin-bottom:16px; color: var(--md-sys-color-on-surface-variant);">
                        Get your domain and token at <a href="https://desec.io" target="_blank" style="color: var(--md-sys-color-primary);">desec.io</a>.
                    </p>
                    <div style="text-align:right;">
                        <button type="submit" class="btn btn-tonal">Save deSEC Config</button>
                    </div>
                </form>
            </div>
            <div class="card">
                <h3>Device DNS Settings</h3>
                <p class="body-medium description">Utilize these RFC-compliant encrypted endpoints to maintain digital independence:</p>
                <div class="code-label" data-tooltip="Standard unencrypted DNS (Port 53). Recommended only for use within your local LAN.">Standard IPv4 (Local LAN Only)</div>
                <div class="code-block sensitive">$LAN_IP:53</div>
                <div class="code-label" data-tooltip="DNS-over-QUIC (DOQ) - RFC 9250. Port 853. High-performance encrypted DNS designed for superior latency and stability.">Secure DOQ (Modern Clients)</div>
                <div class="code-block sensitive">quic://$LAN_IP</div>
                <div class="desec-only" style="display: none;">
                    <div class="code-label" data-tooltip="DNS-over-HTTPS (DOH) - RFC 8484. Standard for web browsers. Queries are indistinguishable from HTTPS traffic.">Secure DOH (Browsers)</div>
                    <div class="code-block sensitive">https://$DESEC_DOMAIN/dns-query</div>
                    <div class="code-label" data-tooltip="DNS-over-TLS (DOT) - RFC 7858. Port 853. The industry standard for Android 'Private DNS' and system resolvers.">Secure DOT (Android / System)</div>
                    <div class="code-block sensitive">$DESEC_DOMAIN:853</div>
                </div>
                <div class="no-desec-only" style="display: none;">
                    <div class="code-label" data-tooltip="Secured DNS via HTTPS">DNS-over-HTTPS</div>
                    <div class="code-block sensitive">https://$LAN_IP/dns-query</div>
                    <div class="code-label" data-tooltip="Secured DNS via TLS">DNS-over-TLS</div>
                    <div class="code-block sensitive">$LAN_IP:853</div>
                </div>
            </div>
            <div class="card">
                <h3>Endpoint Provisioning</h3>
                <div id="dns-setup-trusted" style="display:none; height: 100%; display: flex; flex-direction: column;">
                    <p class="body-medium description">Globally trusted SSL is active via Let's Encrypt and deSEC. This enables zero-trust encrypted DNS on mobile devices without requiring certificate installation.</p>
                    <ol style="margin:12px 0; padding-left:20px; font-size:14px; color:var(--md-sys-color-on-surface); line-height:1.8; flex-grow: 1;">
                        <li data-tooltip="For legacy devices within your home network."><b>Local LAN:</b> Configure devices to use <code class="sensitive">$LAN_IP</code>.</li>
                        <li data-tooltip="Requires establishing the WireGuard VPN tunnel when away from home."><b>VPN Tunnel:</b> Route all traffic through the Privacy Hub.</li>
                        <li data-tooltip="Android 9+ native feature. Encrypts all DNS queries automatically."><b>Mobile Private DNS:</b> Use the hostname below for native encryption.</li>
                    </ol>
                    <div class="code-label" style="margin-top:12px;" data-tooltip="Use this hostname in your Android 'Private DNS' settings.">Mobile Private DNS Hostname</div>
                    <div class="code-block sensitive" style="margin-top:4px;">$DESEC_DOMAIN</div>
                    <div style="margin-top: auto; padding-top: 16px;">
                        <div class="chip vpn" style="width: 100%; justify-content: flex-start; gap: 12px; height: auto; padding: 12px; border-radius: var(--md-sys-shape-corner-medium);">
                            <span class="material-symbols-rounded" style="color: var(--md-sys-color-on-primary-container);">verified_user</span>
                            <div style="display: flex; flex-direction: column; gap: 2px;">
                                <span style="font-weight: 600;">Verified Certificate Authority</span>
                                <span class="body-small" style="opacity: 0.8; white-space: normal;">Trust chain established with Let's Encrypt. Fully compatible with native Private DNS.</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="dns-setup-untrusted" style="display:none; height: 100%; display: flex; flex-direction: column;">
                    <p class="body-medium description" style="color:var(--md-sys-color-error);">Limited Encrypted DNS Coverage</p>
                    <p class="body-small description">
                        Android 'Private DNS' requires a FQDN. Since no domain is configured, your mobile devices cannot utilize native encrypted DNS without the VPN.
                        <br><br>
                        Once a valid SSL certificate is acquired, the configured deSEC domain will automatically be used as the FQDN for this dashboard.
                    </p>
                    <div style="flex-grow: 1;">
                        <div class="code-label" data-tooltip="The local IP address of your privacy hub.">Primary Gateway</div>
                        <div class="code-block sensitive">$LAN_IP</div>
                    </div>
                    <div style="margin-top: auto; padding-top: 16px;">
                        <div class="chip admin" style="width: 100%; justify-content: flex-start; gap: 12px; height: auto; padding: 12px; border-radius: var(--md-sys-shape-corner-medium);">
                            <span class="material-symbols-rounded" style="color: var(--md-sys-color-error);">warning</span>
                            <div style="display: flex; flex-direction: column; gap: 2px;">
                                <span style="font-weight: 600;">Self-Signed (Local)</span>
                                <span class="body-small" style="opacity: 0.8; white-space: normal;">Security warnings will appear. Configure deSEC for trusted SSL and Private DNS.</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="dns-setup-local" style="display:none; height: 100%; display: flex; flex-direction: column;">
                    <p class="body-medium description">The system is currently operating in local-only mode. To maintain privacy, all external traffic should be routed via the local infrastructure:</p>
                    <ol style="margin:12px 0; padding-left:20px; font-size:14px; color:var(--md-sys-color-on-surface); line-height:1.8; flex-grow: 1;">
                        <li>Configure router WAN/LAN DNS to: <b class="sensitive">$LAN_IP</b></li>
                        <li>Remote Access: Establish WireGuard tunnel before accessing services.</li>
                        <li>Legacy Support: Standard Port 53 resolution for older hardware.</li>
                    </ol>
                    <div class="code-block sensitive" style="margin-top:12px;">$LAN_IP</div>
                    <div style="margin-top: auto; padding-top: 16px;">
                        <div class="chip admin" style="width: 100%; justify-content: flex-start; gap: 12px; height: auto; padding: 12px; border-radius: var(--md-sys-shape-corner-medium);">
                            <span class="material-symbols-rounded" style="color: var(--md-sys-color-error);">warning</span>
                            <div style="display: flex; flex-direction: column; gap: 2px;">
                                <span style="font-weight: 600;">Self-Signed (Local)</span>
                                <span class="body-small" style="opacity: 0.8; white-space: normal;">Security warnings will appear. Configure deSEC for trusted SSL and full mobile support.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </section>

        <section data-category="tools">
        <div class="section-label">Service Utilities</div>
        <div id="grid-tools" class="grid">
            <!-- Dynamic Cards Injected Here -->
        </div>
        <div class="grid">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <h3>Odido Status</h3>
                    <div id="odido-speed-indicator" class="body-small" style="color: var(--md-sys-color-primary); font-weight: 500; display:none;">0 Mb/s</div>
                </div>
                <div id="odido-status-container" style="display: flex; flex-direction: column; height: 100%;">
                    <div id="odido-not-configured" style="display:none;">
                        <p class="body-medium" style="color:var(--md-sys-color-on-surface-variant);">Odido Bundle Booster service available. Configure credentials via API or link below.</p>
                        <a href="http://$LAN_IP:8085/docs" target="_blank" class="btn btn-tonal" style="margin-top:12px;">Open API Docs</a>
                    </div>
                    <div id="odido-configured" style="display:none; padding-top: 8px; flex-grow: 1; display: flex; flex-direction: column;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <div class="stat-row"><span class="stat-label">Remaining</span><span class="stat-value" id="odido-remaining">--</span></div>
                                <div class="stat-row"><span class="stat-label">Bundle</span><span class="stat-value" id="odido-bundle-code">--</span></div>
                                <div class="stat-row"><span class="stat-label">Rate</span><span class="stat-value" id="odido-rate">--</span></div>
                            </div>
                            <div>
                                <div class="stat-row"><span class="stat-label">Status</span><span class="stat-value" id="odido-api-status">--</span></div>
                                <div class="stat-row"><span class="stat-label">Threshold</span><span class="stat-value" id="odido-threshold">--</span></div>
                                <div class="stat-row"><span class="stat-label">Auto-Renew</span><span class="stat-value" id="odido-auto-renew">--</span></div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 24px; flex-grow: 1; min-height: 120px; position: relative; background: var(--md-sys-color-surface-container-low); border-radius: 12px; padding: 12px;">
                            <div style="position: absolute; top: 8px; left: 12px; font-size: 10px; color: var(--md-sys-color-on-surface-variant); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Consumption Rate (MB/min)</div>
                            <svg id="odido-graph" width="100%" height="100%" viewBox="0 0 400 120" preserveAspectRatio="none" style="overflow: visible;">
                                <defs>
                                    <linearGradient id="graph-gradient" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="0%" stop-color="var(--md-sys-color-primary)" stop-opacity="0.3"></stop>
                                        <stop offset="100%" stop-color="var(--md-sys-color-primary)" stop-opacity="0"></stop>
                                    </linearGradient>
                                </defs>
                                <path id="graph-area" fill="url(#graph-gradient)" d=""></path>
                                <path id="graph-line" fill="none" stroke="var(--md-sys-color-primary)" stroke-width="2.5" stroke-linejoin="round" d=""></path>
                                <line x1="0" y1="120" x2="400" y2="120" stroke="var(--md-sys-color-outline-variant)" stroke-width="1"></line>
                                <g id="graph-grid" stroke="var(--md-sys-color-outline-variant)" stroke-width="0.5" stroke-dasharray="2,2">
                                    <line x1="0" y1="30" x2="400" y2="30"></line>
                                    <line x1="0" y1="60" x2="400" y2="60"></line>
                                    <line x1="0" y1="90" x2="400" y2="90"></line>
                                </g>
                            </svg>
                        </div>

                        <div id="odido-buy-status" class="body-small" style="text-align: center; margin-top: 8px; font-weight: 500;"></div>
                        <div class="btn-group" style="justify-content:center; margin-top: 16px;">
                            <button onclick="buyOdidoBundle()" class="btn btn-tertiary admin-only" id="odido-buy-btn">Buy Bundle</button>
                            <button onclick="refreshOdidoRemaining()" class="btn btn-tonal">Refresh Status</button>
                            <a href="http://$LAN_IP:8085/docs" target="_blank" class="btn btn-outlined">API</a>
                        </div>
                    </div>
                    <div id="odido-loading" class="chip admin" style="width: 100%; justify-content: flex-start; gap: 12px; height: auto; padding: 12px; border-radius: var(--md-sys-shape-corner-medium); border: none; margin-top: 8px;">
                        <div style="width: 24px; height: 24px; border: 3px solid var(--md-sys-color-on-secondary-container); border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <div style="display: flex; flex-direction: column; gap: 2px;">
                            <span style="font-weight: 600;">Synchronizing Data</span>
                            <span class="body-medium" style="opacity: 0.8; white-space: normal;">Connecting to Odido API to retrieve latest bundle status...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card admin-only">
                <h3>Configuration</h3>
                <p class="body-medium description">Authentication and automation settings for backend services:</p>
                <form onsubmit="saveOdidoConfig(); return false;">
                    <input type="text" id="odido-api-key" class="text-field sensitive" placeholder="Dashboard API Key" style="margin-bottom:12px;" autocomplete="username" data-tooltip="The HUB_API_KEY from your .secrets file.">
                    <p class="body-small" style="margin-bottom:16px; color: var(--md-sys-color-on-surface-variant);">
                        The <strong>Dashboard API Key</strong> (HUB_API_KEY) is required to authorize sensitive actions like saving settings. You can find this in your <code>.secrets</code> file on the host.
                    </p>
                    <input type="password" id="odido-oauth-token" class="text-field sensitive" placeholder="Odido OAuth Token" style="margin-bottom:12px;" autocomplete="current-password" data-tooltip="OAuth token for Odido API authentication.">
                    <p class="body-small" style="margin-bottom:16px; color: var(--md-sys-color-on-surface-variant);">
                        Download and extract the latest <a href="https://github.com/GuusBackup/Odido.Authenticator/releases/latest" target="_blank" style="color: var(--md-sys-color-primary);">Odido.Authenticator</a>.
                        <br><br>
                        <strong>How to use:</strong><br>
                        1. Run <code>Odido.Authenticator.exe</code><br>
                        2. Go to the URL provided in the tool: <code class="sensitive">https://www.odido.nl/login?...</code><br>
                        3. Login into Odido<br>
                        4. Grab the result URL: <code class="sensitive">https://www.odido.nl/loginappresult?token=...</code><br>
                        5. Paste it into the tool and press enter<br>
                        6. It will show the Refresh token now (Decrypted the response)<br>
                        7. Press enter or Y to get an Authentication token from it (This will destroy the refresh token)
                    </p>
                    <input type="text" id="odido-bundle-code-input" class="text-field" placeholder="Bundle Code (default: A0DAY01)" style="margin-bottom:12px;" data-tooltip="The product code for your data bundle.">
                    <input type="number" id="odido-threshold-input" class="text-field" placeholder="Min Threshold MB (default: 100)" style="margin-bottom:12px;" data-tooltip="Automatic renewal triggers when data falls below this level.">
                    <input type="number" id="odido-lead-time-input" class="text-field" placeholder="Lead Time Minutes (default: 30)" style="margin-bottom:12px;" data-tooltip="Lead time before expiration to trigger renewal.">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px;">
                        <div id="odido-config-status" class="body-small" style="font-weight: 500;"></div>
                        <button type="submit" class="btn btn-tonal">Save Configuration</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="section-label admin-only">WireGuard Profiles</div>
        <div class="grid admin-only">
            <div class="card admin-only">
                <h3>Upload Profile</h3>
                <input type="text" id="prof-name" class="text-field" placeholder="Optional: Custom Name" style="margin-bottom:12px;" data-tooltip="Give your profile a recognizable name.">
                <textarea id="prof-conf" class="text-field sensitive" placeholder="Paste .conf content here..." style="margin-bottom:16px;" data-tooltip="Paste the contents of your WireGuard .conf file."></textarea>
                <div style="text-align:right;"><button onclick="uploadProfile()" class="btn btn-filled" data-tooltip="Save this profile. The VPN service will automatically restart to apply the new configuration (~15 seconds).">Upload & Activate</button></div>
            </div>
            <div class="card profile-card admin-only">
                <h3 data-tooltip="Select a profile to activate it. The dashboard will automatically restart dependent services to route their traffic through the new tunnel.">Available Profiles</h3>
                <div id="profile-list" style="flex-grow: 1; display: flex; align-items: center; justify-content: center; min-height: 100px;">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 12px; opacity: 0.7;">
                        <div style="width: 24px; height: 24px; border: 3px solid var(--md-sys-color-primary); border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <span class="body-medium">Scanning Profiles...</span>
                    </div>
                </div>
                <p class="body-small profile-hint" style="margin-top: auto; padding-top: 12px;">Click name to activate.</p>
            </div>
        </div>

        <div class="section-label">Customization & Info</div>
        <div class="grid">
            <div class="card admin-only">
                <div class="card-header">
                    <h3>Theme Customization</h3>
                    <div class="card-header-actions">
                        <button onclick="localStorage.removeItem('theme_seed'); location.reload();" class="btn btn-icon" data-tooltip="Reset theme to default"><span class="material-symbols-rounded">refresh</span></button>
                    </div>
                </div>
                <p class="body-medium description">Personalize the dashboard using Material Design 3 dynamic color algorithms (HCT color space).</p>
                <div style="display: flex; flex-direction: column; gap: 20px; margin-top: 16px;">
                    <div style="background: var(--md-sys-color-surface-container-high); padding: 16px; border-radius: 16px; display: flex; align-items: center; gap: 16px; border: 1px solid var(--md-sys-color-outline-variant);">
                        <div style="position: relative; width: 48px; height: 48px; border-radius: 24px; overflow: hidden; border: 2px solid var(--md-sys-color-primary);">
                            <input type="color" id="theme-seed-color" onchange="applySeedColor(this.value)" style="position: absolute; top: -10px; left: -10px; width: 80px; height: 80px; cursor: pointer; border: none; background: transparent;">
                        </div>
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="label-large">Custom Seed Color</span>
                                <span class="body-small monospace" id="theme-seed-hex" style="opacity: 0.7;">#D0BCFF</span>
                            </div>
                            <p class="body-small" style="color: var(--md-sys-color-on-surface-variant);">Tap the circle to choose a primary tone</p>
                        </div>
                    </div>

                    <div style="background: var(--md-sys-color-surface-container-high); padding: 16px; border-radius: 16px; display: flex; flex-direction: column; gap: 16px; border: 1px solid var(--md-sys-color-outline-variant);">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span class="label-large">Theme Presets</span>
                        </div>
                        <div id="static-presets" style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <!-- Static presets injected here -->
                        </div>

                        <div style="height: 1px; background: var(--md-sys-color-outline-variant); opacity: 0.5;"></div>

                        <div style="display: flex; align-items: center; gap: 16px;">
                            <label for="theme-image-upload" class="btn btn-filled" style="width: 48px; height: 48px; padding: 0; border-radius: 24px; cursor: pointer; flex-shrink: 0;" data-tooltip="Pick a wallpaper to extract colors">
                                <span class="material-symbols-rounded">wallpaper</span>
                            </label>
                            <input type="file" id="theme-image-upload" accept="image/*" onchange="extractColorsFromImage(event)" style="display: none;">
                            <div style="flex: 1;">
                                <span class="label-large">Wallpaper Extraction</span>
                                <p class="body-small" style="color: var(--md-sys-color-on-surface-variant);">Upload image to generate palettes</p>
                            </div>
                        </div>
                        
                        <!-- Extracted Palette -->
                        <div id="extracted-palette" style="display: flex; gap: 12px; flex-wrap: wrap; min-height: 48px; align-items: center;">
                            <span class="body-small" style="opacity: 0.5; font-style: italic;">Extracted palettes will appear here...</span>
                        </div>

                        <!-- Manual Add -->
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="manual-color-input" class="text-field" placeholder="Add Hex (e.g. #FF0000)" style="border-radius: 8px; height: 40px; padding: 0 12px; font-family: monospace;">
                            <button onclick="addManualColor()" class="btn btn-tonal" style="height: 40px;">Add</button>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 8px;">
                        <button onclick="saveThemeSettings()" class="btn btn-tonal" style="flex-grow: 1;"><span class="material-symbols-rounded">save</span> Save Theme</button>
                    </div>
                </div>
            </div>
            <div class="card admin-only">
                <h3>Security & Privacy</h3>
                <p class="body-medium description">Manage administrative session behavior and authentication security.</p>
                <div style="display: flex; flex-direction: column; gap: 16px; margin-top: 16px;">
                    <div id="session-cleanup-warning" class="chip admin" style="display: flex; width: 100%; justify-content: flex-start; gap: 12px; height: auto; padding: 12px; border-radius: 12px; background: var(--md-sys-color-surface-container-highest); color: var(--md-sys-color-on-surface-variant); border: 1px solid var(--md-sys-color-outline-variant); margin-bottom: 4px; transition: all 0.3s ease;">
                        <span class="material-symbols-rounded" id="session-warning-icon">info</span>
                        <div style="display: flex; flex-direction: column; gap: 2px;">
                            <span style="font-weight: 600;" id="session-warning-title">Security Recommendation</span>
                            <span class="body-medium" id="session-warning-text" style="opacity: 0.8; white-space: normal;">Session auto-cleanup is currently active. Your admin session will expire automatically for safety.</span>
                        </div>
                    </div>
                    <div style="background: var(--md-sys-color-surface-container-high); padding: 16px; border-radius: 16px; display: flex; align-items: center; gap: 16px; border: 1px solid var(--md-sys-color-outline-variant);">
                        <div style="flex: 1;">
                            <span class="label-large">Update Strategy</span>
                            <p class="body-small" id="strategy-desc" style="color: var(--md-sys-color-on-surface-variant);">Stable: Use latest git tags (Recommended).</p>
                        </div>
                        <select id="update-strategy-select" class="btn btn-tonal" style="height: 40px; padding: 0 12px;" onchange="updateStrategyChange()">
                            <option value="stable">Stable (Tags)</option>
                            <option value="latest">Latest (Branch)</option>
                        </select>
                    </div>
                    <div style="background: var(--md-sys-color-surface-container-high); padding: 16px; border-radius: 16px; display: flex; align-items: center; gap: 16px; border: 1px solid var(--md-sys-color-outline-variant);">
                        <div style="flex: 1;">
                            <span class="label-large">Session Auto-Cleanup</span>
                            <p class="body-small" style="color: var(--md-sys-color-on-surface-variant);">Automatically expire admin sessions after inactivity.</p>
                        </div>
                        <div class="switch-container" id="session-cleanup-switch" onclick="toggleSessionCleanup()" data-tooltip="Toggle automatic session expiration">
                            <div class="switch-track">
                                <div class="switch-thumb"></div>
                            </div>
                        </div>
                    </div>
                    <div style="background: var(--md-sys-color-surface-container-high); padding: 16px; border-radius: 16px; display: flex; align-items: center; gap: 16px; border: 1px solid var(--md-sys-color-outline-variant);">
                        <div style="flex: 1;">
                            <span class="label-large">Session Timeout (Minutes)</span>
                            <p class="body-small" style="color: var(--md-sys-color-on-surface-variant);">Duration of inactivity before auto-logout (Default: 30 Minutes).</p>
                        </div>
                        <input type="number" id="session-timeout-input" class="text-field" style="width: 80px;" value="30" onchange="syncSettings()">
                    </div>
                    <div style="background: var(--md-sys-color-surface-container-high); padding: 16px; border-radius: 16px; display: flex; flex-direction: column; gap: 12px; border: 1px solid var(--md-sys-color-outline-variant);">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="flex: 1;">
                                <span class="label-large">Global VLESS Tunnel (Xray)</span>
                                <p class="body-small" style="color: var(--md-sys-color-on-surface-variant);">Allow external VLESS connections routed through your VPN.</p>
                            </div>
                            <div class="switch-container" id="xray-switch" onclick="toggleXray()" data-tooltip="Toggle Xray VLESS Service">
                                <div class="switch-track">
                                    <div class="switch-thumb"></div>
                                </div>
                            </div>
                        </div>
                        <div id="xray-settings" style="display: none; flex-direction: column; gap: 8px; border-top: 1px solid var(--md-sys-color-outline-variant); padding-top: 12px;">
                            <div class="code-label">Xray Domain</div>
                            <input type="text" id="xray-domain-input" class="text-field" placeholder="e.g. xray.example.com" value="$XRAY_DOMAIN" onchange="syncSettings()">
                            <div class="code-label">Client UUID</div>
                            <div class="code-block" style="font-size: 11px;">$XRAY_UUID</div>
                            <p class="body-small" style="opacity: 0.7;">Note: Requires Port 443 forwarding. Traffic is routed via Gluetun.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <h3>System Information</h3>
                <p class="body-medium description">Sensitive credentials and core configuration details are stored securely on the host filesystem:</p>
                <div style="display: flex; flex-direction: column; gap: 12px; flex-grow: 1;">
                    <div class="stat-row"><span class="stat-label">Secrets Location</span><span class="stat-value monospace" style="font-size: 12px;">$BASE_DIR/.secrets</span></div>
                    <div class="stat-row"><span class="stat-label">Config Root</span><span class="stat-value monospace" style="font-size: 12px;">$BASE_DIR/config</span></div>
                    <div class="stat-row"><span class="stat-label">Dashboard Port</span><span class="stat-value">$PORT_DASHBOARD_WEB</span></div>
                    <div class="stat-row"><span class="stat-label">Safe Display Mode</span><span class="stat-value">Active (Local)</span></div>
                </div>
                <div class="admin-only" style="margin-top: 24px; display: flex; flex-direction: column; gap: 12px;">
                    <button onclick="checkUpdates()" class="btn btn-tonal" data-tooltip="Check for updates" style="width: 100%; justify-content: flex-start;">
                        <span class="material-symbols-rounded">system_update_alt</span> Check for Updates
                    </button>
                    <button onclick="updateAllServices()" class="btn btn-tonal" data-tooltip="Update all services" style="width: 100%; justify-content: flex-start; background: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container);">
                        <span class="material-symbols-rounded">upgrade</span> Update All Services
                    </button>
                    <button onclick="restartStack()" class="btn btn-tonal" style="width: 100%; justify-content: flex-start; background: var(--md-sys-color-surface-container-highest);">
                        <span class="material-symbols-rounded">restart_alt</span> Restart Stack
                    </button>
                    <button onclick="uninstallStack()" class="btn btn-tonal" style="width: 100%; justify-content: flex-start; background: var(--md-sys-color-error-container); color: var(--md-sys-color-on-error-container);" data-tooltip="Permanently remove all containers and data.">
                        <span class="material-symbols-rounded">delete_forever</span> Uninstall System
                    </button>
                </div>
            </div>
        </div>
        </section>

        <section data-category="logs">
        <div class="section-label">System & Logs</div>
        <div class="grid">
            <div class="card">
                <div class="card-header">
                    <h3>System Health</h3>
                    <div class="card-header-actions">
                        <div class="chip" id="health-status-indicator" style="background: var(--md-sys-color-success-container); color: var(--md-sys-color-on-success-container); border: none; padding: 0 12px; height: 28px; font-weight: 500; gap: 6px; box-shadow: var(--md-sys-elevation-1);">
                            <span class="material-symbols-rounded" id="health-icon" style="font-size: 16px;">check_circle</span>
                            <span id="health-text" style="font-size: 13px; letter-spacing: 0.3px;">Optimal</span>
                        </div>
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 12px; flex-grow: 1;">
                    <div class="stat-row"><span class="stat-label">System CPU</span><span class="stat-value" id="sys-cpu">0%</span></div>
                    <div class="metric-bar"><div id="sys-cpu-fill" class="metric-fill" style="width: 0%"></div></div>
                    
                    <div class="stat-row" style="margin-top:8px;"><span class="stat-label">System RAM</span><span class="stat-value" id="sys-ram">0 MB / 0 MB</span></div>
                    <div class="metric-bar"><div id="sys-ram-fill" class="metric-fill" style="width: 0%"></div></div>

                    <div style="margin-top: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div onclick="openProjectSizeModal()" class="clickable-stat" style="background: var(--md-sys-color-surface-container-highest); padding: 12px; border-radius: 12px; display: flex; flex-direction: column; gap: 4px; cursor: pointer; position: relative; transition: all 200ms ease; border: 1px solid transparent;" onmouseover="this.style.background='var(--md-sys-color-surface-container-high)'; this.style.borderColor='var(--md-sys-color-outline-variant)'" onmouseout="this.style.background='var(--md-sys-color-surface-container-highest)'; this.style.borderColor='transparent'">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <span class="body-small" style="opacity: 0.7;">Project Size</span>
                                <span class="material-symbols-rounded move-on-hover" style="font-size: 16px; opacity: 0.5; transition: transform 200ms ease;">arrow_forward</span>
                            </div>
                            <span class="label-large" id="sys-project-size">-- MB</span>
                        </div>
                        <div style="background: var(--md-sys-color-surface-container-highest); padding: 12px; border-radius: 12px; display: flex; flex-direction: column; gap: 4px;">
                            <span class="body-small" style="opacity: 0.7;">System Uptime</span>
                            <span class="label-large" id="sys-uptime">--</span>
                        </div>
                    </div>

                    <div style="margin-top: auto; padding-top: 16px; border-top: 1px solid var(--md-sys-color-outline-variant); display: flex; justify-content: space-between; align-items: center; gap: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px; flex-grow: 1;">
                            <span class="material-symbols-rounded" style="font-size: 20px; color: var(--md-sys-color-primary);">hard_drive</span>
                            <span class="body-medium" data-tooltip="SMART Health Status" id="drive-health-container" style="display: flex; gap: 8px; align-items: center;">
                                Drive Health: <strong id="sys-drive-status">Checking...</strong>
                                <span id="sys-drive-pct" style="margin-left: 8px; opacity: 0.8;"></span>
                            </span>
                        </div>
                        <span class="body-small" id="sys-disk-percent" style="white-space: nowrap;">--% used</span>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3>System & Deployment Logs</h3>
                    <div class="card-header-actions">
                        <select id="log-filter-level" onchange="filterLogs()" class="btn btn-tonal" style="height: 32px; padding: 0 16px 0 8px; font-size: 12px; border-radius: 8px;">
                            <option value="ALL">All Levels</option>
                            <option value="INFO">Info</option>
                            <option value="WARN">Warn</option>
                            <option value="ERROR">Error</option>
                            <option value="SECURITY">Security</option>
                        </select>
                        <select id="log-filter-cat" onchange="filterLogs()" class="btn btn-tonal" style="height: 32px; padding: 0 16px 0 8px; font-size: 12px; border-radius: 8px;">
                            <option value="ALL">All Categories</option>
                            <option value="SYSTEM">System</option>
                            <option value="NETWORK">Network</option>
                            <option value="MAINTENANCE">Maintenance</option>
                        </select>
                    </div>
                </div>
                <div id="log-container" class="log-container sensitive" style="display: flex; align-items: center; justify-content: center;">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 12px; opacity: 0.7;">
                        <div style="width: 24px; height: 24px; border: 3px solid var(--md-sys-color-primary); border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <span class="body-medium">Connecting to Log Stream...</span>
                    </div>
                </div>
                <div id="log-status" class="body-small" style="color:var(--md-sys-color-on-surface-variant); text-align:right; margin-top:8px;">Connecting...</div>
            </div>
        </div>
        </section>

    <!-- Update Selection Modal -->
    <div id="update-selection-modal" class="modal-overlay">
        <div class="modal-card" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Select Updates</h2>
                <button onclick="closeUpdateModal()" class="btn btn-icon"><span class="material-symbols-rounded">close</span></button>
            </div>
            <div style="padding: 16px 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span class="body-medium" id="update-fetch-status" style="color: var(--md-sys-color-on-surface-variant);">Scanning for updates...</span>
                    <button onclick="toggleAllUpdates()" class="btn btn-tonal" style="height: 32px; font-size: 12px;">Reset / Undo</button>
                </div>
                <div id="update-list-container" style="background: var(--md-sys-color-surface-container-low); border-radius: 12px; padding: 8px; max-height: 300px; overflow-y: auto;">
                    <!-- Checkboxes injected here -->
                    <div style="padding: 24px; text-align: center; opacity: 0.6;">
                        <div style="width: 24px; height: 24px; border: 3px solid var(--md-sys-color-primary); border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px auto;"></div>
                        <span class="body-medium">Checking repositories...</span>
                    </div>
                </div>
            </div>
            <div class="btn-group" style="justify-content: flex-end;">
                <button onclick="startBatchUpdate()" class="btn btn-filled" id="start-update-btn" disabled>Update Selected</button>
            </div>
        </div>
    </div>

    <!-- Changelog Modal -->
    <div id="changelog-modal" class="modal-overlay" style="z-index: 26000;">
        <div class="modal-card" style="max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h2 id="changelog-title">Changelog</h2>
                <button onclick="document.getElementById('changelog-modal').style.display='none'" class="btn btn-icon"><span class="material-symbols-rounded">close</span></button>
            </div>
            <div id="changelog-content" class="code-block" style="flex-grow: 1; overflow-y: auto; white-space: pre-wrap; margin-top: 16px; font-family: monospace; font-size: 13px;">
                Loading...
            </div>
        </div>
    </div>

    <!-- Service Management Modal -->
    <div id="service-modal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h2 id="modal-service-name">Service Settings</h2>
                <button onclick="closeServiceModal()" class="btn btn-icon"><span class="material-symbols-rounded">close</span></button>
            </div>
            <div id="modal-metrics" style="background: var(--md-sys-color-surface-container-low); padding: 16px; border-radius: 12px;">
                <div class="stat-row">
                    <span class="stat-label">CPU Usage <span id="modal-cpu-text" style="float:right; font-family:monospace; opacity:0.8;">0%</span></span>
                    <span class="stat-value" id="modal-cpu" style="display:none;">0%</span>
                </div>
                <div class="metric-bar"><div id="modal-cpu-fill" class="metric-fill" style="width: 0%"></div></div>
                
                <div class="stat-row" style="margin-top:12px;">
                                <span class="stat-label">Memory <span id="modal-mem-text" style="float:right; font-family:monospace; opacity:0.8;">0 MB / 0 MB</span></span>
                                <span class="stat-value" id="modal-mem" style="display:none;">0 MB / 0 MB</span>                </div>
                <div class="metric-bar"><div id="modal-mem-fill" class="metric-fill" style="width: 0%"></div></div>
            </div>
            <div id="modal-actions" class="btn-group" style="flex-direction: column; gap: 8px;">
                <!-- Actions injected via JS -->
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h2>Admin Authentication</h2>
                <button onclick="closeLoginModal()" class="btn btn-icon"><span class="material-symbols-rounded">close</span></button>
            </div>
            <p class="body-medium" style="margin-bottom: 24px; color: var(--md-sys-color-on-surface-variant);">Enter your administrator password to unlock management features.</p>
            <form onsubmit="submitLogin(); return false;">
                <!-- Hidden username field for accessibility/autofill -->
                <input type="text" name="username" value="admin" style="display:none" autocomplete="username">
                <input type="password" id="admin-password-input" class="text-field" placeholder="Password" style="margin-bottom: 24px; border-radius: 4px;" autocomplete="current-password">
                <div style="display: flex; justify-content: flex-end; gap: 12px;">
                    <button type="button" onclick="closeLoginModal()" class="btn btn-outlined">Cancel</button>
                    <button type="submit" class="btn btn-filled">Unlock</button>
                </div>
            </form>
        </div>
    </div>

    <script>
{{DHI_JS}}
    </script>
    <script>
        // DNS Setup Visibility Logic
        (function() {
            const hasDesec = "$DESEC_DOMAIN" !== "";
            if (hasDesec) {
                document.querySelectorAll('.desec-only').forEach(el => el.style.display = 'block');
                document.getElementById('dns-setup-trusted').style.display = 'flex';
            } else {
                document.querySelectorAll('.no-desec-only').forEach(el => el.style.display = 'block');
                document.getElementById('dns-setup-local').style.display = 'flex';
            }
        })();
    </script>
    <!-- Project Size Details Modal -->
    <div id="project-size-modal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h2 id="modal-project-title">Storage Breakdown</h2>
                <button onclick="closeProjectSizeModal()" class="btn btn-icon"><span class="material-symbols-rounded">close</span></button>
            </div>
            <div id="project-size-details" style="display: flex; flex-direction: column; gap: 16px;">
                <div class="loading-spinner" id="project-size-loading" style="margin: 20px auto;"></div>
                <div id="project-size-content" style="display: none;">
                    <div style="display: flex; flex-direction: column; gap: 12px;" id="project-size-list">
                        <!-- Dynamic content -->
                    </div>
                    <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--md-sys-color-outline-variant); display: flex; flex-direction: column; gap: 12px;">
                        <button onclick="purgeUnusedImages(event)" class="btn btn-filled" style="width: 100%; justify-content: center; background: var(--md-sys-color-error-container); color: var(--md-sys-color-on-error-container);">
                            <span class="material-symbols-rounded">broom</span>
                            <span>Purge Unused Images</span>
                        </button>
                        <p class="body-small" style="opacity: 0.7; text-align: center;">Safe removal of dangling images and unused build cache.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
