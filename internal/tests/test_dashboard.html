<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZimaOS Privacy Hub</title>
    <!-- Local privacy friendly fonts (Hosted Locally) -->
    <link href="fonts/gs.css" rel="stylesheet">
    <link href="fonts/cc.css" rel="stylesheet">
    <link href="fonts/ms.css" rel="stylesheet">
    <style>
        /* ============================================
           Material 3 Dark Theme - Strict Implementation
           Reference: https://m3.material.io/
           ============================================ */
        
        :root {
            color-scheme: dark;
            /* M3 Dark Theme Color Tokens (Default) */
            --md-sys-color-primary: #D0BCFF;
            --md-sys-color-on-primary: #381E72;
            --md-sys-color-primary-container: #4F378B;
            --md-sys-color-on-primary-container: #EADDFF;
            --md-sys-color-secondary: #CCC2DC;
            --md-sys-color-on-secondary: #332D41;
            --md-sys-color-secondary-container: #4A4458;
            --md-sys-color-on-secondary-container: #E8DEF8;
            --md-sys-color-tertiary: #EFB8C8;
            --md-sys-color-on-tertiary: #492532;
            --md-sys-color-tertiary-container: #633B48;
            --md-sys-color-on-tertiary-container: #FFD8E4;
            --md-sys-color-error: #F2B8B5;
            --md-sys-color-on-error: #601410;
            --md-sys-color-error-container: #8C1D18;
            --md-sys-color-on-error-container: #F9DEDC;
            --md-sys-color-surface: #141218;
            --md-sys-color-on-surface: #E6E1E5;
            --md-sys-color-surface-variant: #49454F;
            --md-sys-color-on-surface-variant: #CAC4D0;
            --md-sys-color-surface-container-low: #1D1B20;
            --md-sys-color-surface-container: #211F26;
            --md-sys-color-surface-container-high: #2B2930;
            --md-sys-color-surface-container-highest: #36343B;
            --md-sys-color-surface-bright: #3B383E;
            --md-sys-color-outline: #938F99;
            --md-sys-color-outline-variant: #49454F;
            --md-sys-color-inverse-surface: #E6E1E5;
            --md-sys-color-inverse-on-surface: #313033;
            --md-sys-color-success: #A8DAB5;
            --md-sys-color-on-success: #003912;
            --md-sys-color-success-container: #00522B;
            --md-sys-color-warning: #FFCC80;
            --md-sys-color-on-warning: #4A2800;

            /* MD3 Expressive Motion */
            --md-sys-motion-easing-emphasized: cubic-bezier(0.2, 0.0, 0, 1.0);
            --md-sys-motion-duration-short: 150ms;
            --md-sys-motion-duration-medium: 300ms;
            --md-sys-motion-duration-long: 500ms;
            
            /* MD3 Expressive Shapes */
            --md-sys-shape-corner-extra-large: 28px;
            --md-sys-shape-corner-large: 16px;
            --md-sys-shape-corner-medium: 12px;
            --md-sys-shape-corner-small: 8px;
            --md-sys-shape-corner-full: 100px;

            /* Elevation */
            --md-sys-elevation-1: 0 1px 3px 1px rgba(0,0,0,0.15), 0 1px 2px rgba(0,0,0,0.3);
            --md-sys-elevation-2: 0 2px 6px 2px rgba(0,0,0,0.15), 0 1px 2px rgba(0,0,0,0.3);
            --md-sys-elevation-3: 0 4px 8px 3px rgba(0,0,0,0.15), 0 1px 3px rgba(0,0,0,0.3);
            
            /* State Opacities */
            --md-sys-state-hover-opacity: 0.08;
            --md-sys-state-focus-opacity: 0.12;
            --md-sys-state-pressed-opacity: 0.12;
        }

        /* M3 Light Theme Tokens */
        :root.light-mode {
            color-scheme: light;
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            --md-sys-color-secondary: #625B71;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #E8DEF8;
            --md-sys-color-on-secondary-container: #1D192B;
            --md-sys-color-tertiary: #7D5260;
            --md-sys-color-on-tertiary: #FFFFFF;
            --md-sys-color-tertiary-container: #FFD8E4;
            --md-sys-color-on-tertiary-container: #31111D;
            --md-sys-color-error: #B3261E;
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-error-container: #F9DEDC;
            --md-sys-color-on-error-container: #410E0B;
            --md-sys-color-surface: #FEF7FF;
            --md-sys-color-on-surface: #1D1B20;
            --md-sys-color-surface-variant: #E7E0EC;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-surface-container-low: #F7F2FA;
            --md-sys-color-surface-container: #F3EDF7;
            --md-sys-color-surface-container-high: #ECE6F0;
            --md-sys-color-surface-container-highest: #E6E0E9;
            --md-sys-color-surface-bright: #FEF7FF;
            --md-sys-color-outline: #79747E;
            --md-sys-color-outline-variant: #C4C7C5;
            --md-sys-color-inverse-surface: #313033;
            --md-sys-color-inverse-on-surface: #F4EFF4;
            --md-sys-color-success: #2E7D32;
            --md-sys-color-on-success: #FFFFFF;
            --md-sys-color-success-container: #C8E6C9;
            --md-sys-color-warning: #ED6C02;
            --md-sys-color-on-warning: #FFFFFF;
            
            /* Adjust elevations for light mode */
            --md-sys-elevation-1: 0 1px 2px 0 rgba(0,0,0,0.3), 0 1px 3px 1px rgba(0,0,0,0.15);
            --md-sys-elevation-2: 0 1px 2px 0 rgba(0,0,0,0.3), 0 2px 6px 2px rgba(0,0,0,0.15);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        a {
            color: var(--md-sys-color-primary);
            text-decoration: none;
            transition: opacity var(--md-sys-motion-duration-short) linear;
        }
        
        a:hover {
            opacity: 0.8;
            text-decoration: underline;
        }
        
        body {
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-family: 'Google Sans Flex', 'Google Sans', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        .code-block, .log-container, .text-field, .stat-value, .monospace {
            font-family: 'Cascadia Code', 'Consolas', monospace;
        }
        
        .material-symbols-rounded {
            font-family: 'Material Symbols Rounded';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-smoothing: antialiased;
        }

        .container { max-width: 1280px; width: 100%; margin: 0 auto; position: relative; }
        
        /* Header */
        header {
            margin-bottom: 56px;
            padding: 16px 0;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
            flex-wrap: wrap;
        }

        .header-row > div:first-child {
            flex: 1 1 auto;
        }
        
        h1 {
            font-family: 'Google Sans Flex', 'Google Sans', sans-serif;
            font-weight: 400;
            font-size: 45px;
            line-height: 52px;
            margin: 0;
            color: var(--md-sys-color-primary);
            letter-spacing: 0;
        }
        
        .subtitle {
            font-size: 22px;
            color: var(--md-sys-color-on-surface-variant);
            margin-top: 12px;
            font-weight: 400;
            letter-spacing: 0;
        }

        .label-large {
            font-size: 14px;
            line-height: 20px;
            font-weight: 500;
            letter-spacing: 0.1px;
        }

        .body-medium {
            font-size: 14px;
            line-height: 20px;
            letter-spacing: 0.25px;
        }

        .body-small {
            font-size: 12px;
            line-height: 16px;
            letter-spacing: 0.4px;
        }

        .code-label {
            font-size: 12px;
            line-height: 16px;
            letter-spacing: 0.4px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            margin-top: 12px;
        }

        .profile-hint {
            color: var(--md-sys-color-on-surface-variant);
            margin-top: 12px;
        }

        .feedback {
            margin-top: 12px;
            padding: 8px 12px;
            border-radius: var(--md-sys-shape-corner-medium);
            background: var(--md-sys-color-surface-container-highest);
            color: var(--md-sys-color-on-surface-variant);
            font-size: 12px;
            line-height: 16px;
            letter-spacing: 0.4px;
        }

        .feedback.info { border: 1px solid var(--md-sys-color-outline-variant); }
        .feedback.success { background: var(--md-sys-color-success-container); color: var(--md-sys-color-on-success); }
        .feedback.error { background: var(--md-sys-color-error-container); color: var(--md-sys-color-on-error-container); }
        
        /* Section Labels */
        .section-label {
            color: var(--md-sys-color-primary);
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 0.1px;
            margin: 48px 0 16px 4px;
            text-transform: none;
        }
        
        .section-label:first-of-type {
            margin-top: 8px;
        }
        
        .section-hint {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            margin: 0 0 24px 4px;
            letter-spacing: 0.25px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        /* Grid Layouts */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 24px; margin-bottom: 32px; }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 32px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 32px; }
        @media (max-width: 1100px) { .grid-3 { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 900px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
        
        /* MD3 Component Refinements - Elevated Cards */
        .card {
            background: var(--md-sys-color-surface-container-low);
            border-radius: var(--md-sys-shape-corner-extra-large);
            padding: 32px;
            text-decoration: none;
            color: inherit;
            transition: all var(--md-sys-duration-medium) var(--md-sys-motion-easing-emphasized);
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 240px;
            overflow: visible; 
            box-sizing: border-box;
            box-shadow: var(--md-sys-elevation-1);
            height: 100%;
            cursor: pointer;
        }
        
        .card::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: var(--md-sys-color-on-surface);
            opacity: 0;
            transition: opacity var(--md-sys-duration-short) linear;
            pointer-events: none;
            z-index: 1;
        }
        
        .card:hover::before { opacity: var(--md-sys-state-hover-opacity); }
        .card:hover { 
            background: var(--md-sys-color-surface-container);
            box-shadow: var(--md-sys-elevation-2);
            transform: translateY(-4px);
        }
        
        .card:active::before { opacity: var(--md-sys-state-pressed-opacity); }
        .card.full-width { grid-column: 1 / -1; }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 16px;
            flex-wrap: wrap; /* Allowed wrap for small screens */
        }

        .card-header h2 {
            margin: 0;
            font-size: 22px;
            font-weight: 400;
            color: var(--md-sys-color-on-surface);
            line-height: 28px;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .nav-arrow {
            color: var(--md-sys-color-outline);
            font-size: 20px;
            transition: transform var(--md-sys-motion-duration-medium) var(--md-sys-motion-easing-emphasized), color var(--md-sys-motion-duration-short) linear;
        }

        .card:hover .nav-arrow {
            transform: translateX(4px);
            color: var(--md-sys-color-primary);
        }

        .card .description {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 24px; /* Increased spacing */
            line-height: 20px;
            flex-grow: 1;
        }
        
        .card h3 {
            margin: 0 0 16px 0;
            font-size: 16px; /* Title Medium */
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            line-height: 24px;
            letter-spacing: 0.15px;
        }
        
        /* MD3 Assist Chips */
        .chip-box { 
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 8px; 
            padding-top: 12px;
            position: relative;
            z-index: 2;
            align-items: center;
            margin-top: auto;
            width: 100%;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .chip-box::-webkit-scrollbar {
            display: none;
        }
        
        .chip {
            display: inline-flex;
            align-items: center;
            gap: 10px; /* Increased gap for M3 */
            height: 32px;
            padding: 0 12px;
            border-radius: 8px;
            font-size: 14px; /* Label Large */
            font-weight: 500;
            letter-spacing: 0.1px;
            text-decoration: none;
            transition: all var(--md-sys-motion-duration-short) linear;
            border: 1px solid var(--md-sys-color-outline);
            background: transparent;
            color: var(--md-sys-color-on-surface);
            position: relative;
            overflow: hidden;
            white-space: nowrap;
        }

        .chip .material-symbols-rounded {
            font-size: 18px;
            pointer-events: none;
        }
        
        .chip::before {
            content: '';
            position: absolute;
            inset: 0;
            background: currentColor;
            opacity: 0;
            transition: opacity var(--md-sys-motion-duration-short) linear;
        }
        
        .chip:hover::before { opacity: var(--md-sys-state-hover-opacity); }
        
        .chip.vpn { background: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); border: none; }
        .chip.admin { background: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container); border: none; }
        .chip.tertiary { background: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-tertiary-container); border: none; }
        
        /* Category Badges (Informational) */
        .category-badge {
            border: none;
            background: var(--md-sys-color-surface-container-high);
            color: var(--md-sys-color-on-surface-variant);
            padding: 0 12px 0 8px;
            pointer-events: none;
        }
        
        /* Status Indicator */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--md-sys-color-surface-container-highest);
            padding: 6px 12px;
            border-radius: var(--md-sys-shape-corner-full);
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            width: fit-content;
            flex-shrink: 0;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--md-sys-color-outline);
        }
        
        .status-dot.up { background: var(--md-sys-color-success); box-shadow: 0 0 8px var(--md-sys-color-success); }
        .status-dot.down { background: var(--md-sys-color-error); box-shadow: 0 0 8px var(--md-sys-color-error); }
        .status-dot.healthy { background: var(--md-sys-color-success); box-shadow: 0 0 8px var(--md-sys-color-success); }
        .status-dot.starting { background: var(--md-sys-color-warning); box-shadow: 0 0 8px var(--md-sys-color-warning); }
        .status-dot.unhealthy { background: var(--md-sys-color-error); box-shadow: 0 0 8px var(--md-sys-color-error); }
        
        /* MD3 Text Fields */
        .text-field {
            width: 100%;
            background: var(--md-sys-color-surface-container-highest);
            border: none;
            border-bottom: 1px solid var(--md-sys-color-on-surface-variant);
            color: var(--md-sys-color-on-surface);
            padding: 16px;
            border-radius: 4px 4px 0 0;
            font-size: 16px;
            box-sizing: border-box;
            outline: none;
            transition: all var(--md-sys-motion-duration-short) linear;
        }
        
        .text-field:focus {
            border-bottom: 2px solid var(--md-sys-color-primary);
            background: var(--md-sys-color-surface-container-highest);
        }
        
        textarea.text-field { min-height: 120px; resize: vertical; }
        
        /* MD3 Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 0 24px;
            height: 40px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 0.1px;
            cursor: pointer;
            transition: all var(--md-sys-motion-duration-short) linear;
            border: none;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            font-family: inherit;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: currentColor;
            opacity: 0;
            transition: opacity var(--md-sys-motion-duration-short) linear;
        }
        
        .btn:hover::before { opacity: 0.08; }
        
        .btn-filled { background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); box-shadow: var(--md-sys-elevation-1); }
        .btn-tonal { background: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container); }
        .btn-outlined { background: transparent; color: var(--md-sys-color-primary); border: 1px solid var(--md-sys-color-outline); }
        .btn-tertiary { background: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-tertiary-container); }
        
        .btn-icon:hover {
            background: rgba(202, 196, 208, 0.08);
            border-color: var(--md-sys-color-outline);
        }
        
        .portainer-link {
            text-decoration: none;
            cursor: pointer;
            transition: all var(--md-sys-motion-duration-short) linear;
            position: relative;
            pointer-events: auto;
            z-index: 10;
        }
        .portainer-link:hover {
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            border-color: transparent;
            opacity: 0.9;
        }
        
        .btn-action {
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            border-radius: var(--md-sys-shape-corner-medium);
            box-shadow: var(--md-sys-elevation-1);
        }
        
        .btn-icon { width: 40px; height: 40px; padding: 0; border-radius: 20px; }
        .btn-icon svg { width: 24px; height: 24px; fill: currentColor; }
        
        /* MD3 Switch */
        .switch-container {
            display: inline-flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            padding: 8px 0;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .switch-track {
            width: 52px;
            height: 32px;
            background: var(--md-sys-color-surface-container-highest);
            border: 2px solid var(--md-sys-color-outline);
            border-radius: 16px;
            position: relative;
            transition: all var(--md-sys-motion-duration-short) linear;
        }

        .switch-thumb {
            width: 16px;
            height: 16px;
            background: var(--md-sys-color-outline);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 6px;
            transform: translateY(-50%);
            transition: all var(--md-sys-motion-duration-short) var(--md-sys-motion-easing-emphasized);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .switch-container.active .switch-track { background: var(--md-sys-color-primary); border-color: var(--md-sys-color-primary); }
        .switch-container.active .switch-thumb { width: 24px; height: 24px; left: 24px; background: var(--md-sys-color-on-primary); }

        /* Tooltips */
        [data-tooltip] { 
            position: relative; 
        }
        
        .tooltip-box {
            position: fixed;
            background: var(--md-sys-color-inverse-surface);
            color: var(--md-sys-color-inverse-on-surface);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 400;
            line-height: 16px;
            max-width: 280px;
            z-index: 10000;
            box-shadow: var(--md-sys-elevation-2);
            pointer-events: none;
            opacity: 0;
            display: none;
            transition: opacity 150ms var(--md-sys-motion-easing-emphasized);
            text-align: center;
        }
        
        .tooltip-box.visible { opacity: 1; }

        /* Ensure parent elements don't clip tooltips */
        .card, .chip, .status-indicator, li, span, div {
            /* Tooltip container safety */
        }
        
        .card {
            /* ... existing ... */
            overflow: visible; /* Changed from hidden to allow tooltips to escape */
        }
        
        /* Prevent card content overlapping */
        .card > * {
            position: relative;
            z-index: 2;
        }
        
        .card::before {
            /* ... existing ... */
            z-index: 1;
        }

        .log-container {
            background: var(--md-sys-color-surface-container-highest);
            border-radius: var(--md-sys-shape-corner-large);
            padding: 16px;
            flex-grow: 1;
            max-height: 400px;
            overflow-y: auto;
            font-size: 13px;
            color: var(--md-sys-color-on-surface-variant);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .log-entry {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            line-height: 1.5;
            padding: 2px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .log-entry:last-child { border-bottom: none; }
        
        .log-icon {
            font-size: 18px !important;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .log-content {
            flex-grow: 1;
            overflow-wrap: anywhere;
        }

        .log-time {
            opacity: 0.5;
            font-size: 0.85em;
            white-space: nowrap;
            flex-shrink: 0;
            margin-top: 3px;
        }

        /* Snackbar / Toast */
        .snackbar-container {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }

        .snackbar {
            min-width: 320px;
            max-width: 560px;
            background: var(--md-sys-color-inverse-surface);
            color: var(--md-sys-color-inverse-on-surface);
            border-radius: var(--md-sys-shape-corner-small);
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            box-shadow: var(--md-sys-elevation-3);
            pointer-events: auto;
            opacity: 0;
            transform: translateY(20px);
            transition: all var(--md-sys-motion-duration-long) var(--md-sys-motion-easing-emphasized);
        }

        .snackbar.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .snackbar-content { flex-grow: 1; font-size: 14px; letter-spacing: 0.25px; }
        .snackbar-action { 
            color: var(--md-sys-color-primary); 
            font-weight: 500; 
            text-transform: uppercase; 
            cursor: pointer; 
            font-size: 14px;
            background: none;
            border: none;
            padding: 8px;
            margin: -8px;
        }

        /* Theme Toggle */
        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: var(--md-sys-color-surface-container-high);
            color: var(--md-sys-color-on-surface);
            transition: all var(--md-sys-motion-duration-short) linear;
        }
        
        .theme-toggle:hover { background: var(--md-sys-color-surface-container-highest); }

        /* Setup Wizard Overlay */
        .wizard-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(4px);
            z-index: 30000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .wizard-card {
            background: var(--md-sys-color-surface-container-high);
            border-radius: var(--md-sys-shape-corner-extra-large);
            max-width: 600px;
            width: 100%;
            padding: 40px;
            box-shadow: var(--md-sys-elevation-3);
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .wizard-step { display: none; }
        .wizard-step.active { display: flex; flex-direction: column; gap: 16px; }

        /* Service Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 25000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .modal-card {
            background: var(--md-sys-color-surface-container-high);
            border-radius: var(--md-sys-shape-corner-extra-large);
            max-width: 500px;
            width: 100%;
            padding: 32px;
            box-shadow: var(--md-sys-elevation-3);
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .modal-header { display: flex; align-items: center; justify-content: space-between; }
        
        .metric-bar {
            height: 4px;
            width: 100%;
            background: var(--md-sys-color-surface-container-highest);
            border-radius: 2px;
            margin-top: 4px;
            overflow: hidden;
        }
        
        .metric-fill {
            height: 100%;
            background: var(--md-sys-color-primary);
            transition: width 1s ease-in-out;
        }
        
        .code-block {
            background: var(--md-sys-color-surface-container-highest);
            border-radius: var(--md-sys-shape-corner-small);
            padding: 14px 16px;
            font-size: 13px;
            color: var(--md-sys-color-primary);
            margin: 8px 0;
            overflow-x: auto;
        }
        
        .sensitive { transition: filter 400ms var(--md-sys-motion-easing-emphasized); }
        .privacy-mode .sensitive { filter: blur(6px); opacity: 0.4; }

        .sensitive-masked { opacity: 0.7; letter-spacing: 0.3px; }
        
        .text-success { color: var(--md-sys-color-success); }
        .success { color: var(--md-sys-color-success); }
        .error { color: var(--md-sys-color-error); }
        .stat-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 12px; 
            font-size: 14px; 
            gap: 12px;
        }
        .stat-label { 
            color: var(--md-sys-color-on-surface-variant); 
            flex: 1 1 160px;
        }
        .stat-value {
            text-align: right;
            flex: 1 1 200px;
            overflow-wrap: anywhere;
        }
        
        .btn-group { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; }
        .list-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 16px; 
            margin: 0 -16px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant); 
            gap: 16px; 
            flex-wrap: wrap;
            transition: background-color var(--md-sys-motion-duration-short) linear;
            border-radius: var(--md-sys-shape-corner-small);
        }
        .list-item:hover {
            background-color: rgba(230, 225, 229, 0.08);
        }
        .list-item:last-child { border-bottom: none; }
        .list-item-text { cursor: pointer; flex: 1 1 220px; font-weight: 500; overflow-wrap: anywhere; font-size: 16px; letter-spacing: 0.5px; }

        @media (max-width: 720px) {
            body { padding: 16px; }
            h1 { font-size: 36px; line-height: 42px; }
            .subtitle { font-size: 18px; line-height: 24px; }
        }

        @media (max-width: 600px) {
            .header-row { gap: 16px; }
            .switch-container { width: 100%; justify-content: space-between; }
            .stat-row, .list-item { flex-direction: column; align-items: flex-start; }
            .stat-value { text-align: left; }
            .card-header { align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-row">
                <div>
                    <h1>Privacy Hub</h1>
                    <div class="subtitle">Self-hosted network security and private service infrastructure.</div>
                </div>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div class="theme-toggle" onclick="toggleTheme()" data-tooltip="Switch between Light and Dark mode">
                        <span class="material-symbols-rounded" id="theme-icon">light_mode</span>
                    </div>
                    <div class="switch-container" id="privacy-switch" onclick="togglePrivacy()" data-tooltip="Redact identifying metrics for safe display">
                        <span class="label-large">Safe Display Mode</span>
                        <div class="switch-track">
                            <div class="switch-thumb"></div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div id="update-banner" style="display:none; margin-bottom: 32px;">
            <div class="card" style="min-height: auto; padding: 24px; background: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container);">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 24px; flex-wrap: wrap;">
                    <div>
                        <h3 style="margin:0; color: inherit;">Updates Available</h3>
                        <p class="body-medium" id="update-list" style="margin: 8px 0 0 0; color: inherit; opacity: 0.9;">New versions detected for some services.</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="updateAllServices()" class="btn btn-filled" style="background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary);" data-tooltip="Pull latest source code and rebuild containers for all pending services.">Update All</button>
                        <button onclick="this.closest('#update-banner').style.display='none'" class="btn btn-outlined" style="border-color: currentColor; color: inherit;">Dismiss</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-label">Applications</div>
        <div class="section-hint" style="display: flex; gap: 8px; flex-wrap: wrap;">
            <span class="chip category-badge" data-tooltip="Services isolated within a secure VPN tunnel (Gluetun). This allows you to host your own private instances—removing the need to trust third-party hosts—while ensuring your home IP remains hidden from end-service providers."><span class="material-symbols-rounded">vpn_lock</span> VPN Protected</span>
            <span class="chip category-badge" data-tooltip="Local services accessed directly through the internal network interface."><span class="material-symbols-rounded">lan</span> Direct Access</span>
            <span class="chip category-badge" data-tooltip="Advanced infrastructure control and container telemetry via Portainer."><span class="material-symbols-rounded">hub</span> Infrastructure</span>
        </div>
        <div class="grid-3">
            <div id="link-invidious" data-url="http://10.0.1.204:3000" class="card" data-check="true" data-container="invidious" onclick="navigate(this, event)">
                <div class="card-header">
                    <h2>Invidious</h2>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="status-indicator"><span class="status-dot"></span><span class="status-text">Initializing...</span></div><button onclick="openServiceSettings('invidious', event)" class="btn btn-icon settings-btn" data-tooltip="Service Management & Metrics"><span class="material-symbols-rounded">settings</span></button>
                        <button onclick="openServiceSettings('invidious', event)" class="btn btn-icon" data-tooltip="Service Management & Metrics"><span class="material-symbols-rounded">settings</span></button>
                        <span class="material-symbols-rounded nav-arrow">arrow_forward</span>
                    </div>
                </div>
                <p class="description">A privacy-respecting YouTube frontend. Eliminates advertisements and tracking while providing a lightweight interface without proprietary JavaScript.</p>
                <div class="chip-box">
                    <span class="chip vpn portainer-link" data-container="invidious" data-tooltip="Manage Invidious Container"><span class="material-symbols-rounded">vpn_lock</span> Private Instance</span>
                </div>
            </div>
            <div id="link-redlib" data-url="http://10.0.1.204:8080" class="card" data-check="true" data-container="redlib" onclick="navigate(this, event)">
                <div class="card-header">
                    <h2>Redlib</h2>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="status-indicator"><span class="status-dot"></span><span class="status-text">Initializing...</span></div><button onclick="openServiceSettings('redlib', event)" class="btn btn-icon settings-btn" data-tooltip="Service Management & Metrics"><span class="material-symbols-rounded">settings</span></button><button class="btn btn-icon settings-btn" style="margin-left: 8px;"><span class="material-symbols-rounded">settings</span></button>
                        <span class="material-symbols-rounded nav-arrow">arrow_forward</span>
                    </div>
                </div>
                <p class="description">A lightweight Reddit frontend that prioritizes privacy. Strips tracking pixels and unnecessary scripts to ensure a clean, performant browsing experience.</p>
                <div class="chip-box"><span class="chip vpn portainer-link" data-container="redlib" data-tooltip="Manage Redlib Container"><span class="material-symbols-rounded">vpn_lock</span> Private Instance</span>
            </div>
            <div id="link-wikiless" data-url="http://10.0.1.204:8180" class="card" data-check="true" data-container="wikiless" onclick="navigate(this, event)">
                <div class="card-header"><h2>Wikiless</h2><div style="display: flex; align-items: center; gap: 12px;"><div class="status-indicator"><span class="status-dot"></span><span class="status-text">Initializing...</span></div><button onclick="openServiceSettings('wikiless', event)" class="btn btn-icon settings-btn" data-tooltip="Service Management & Metrics"><span class="material-symbols-rounded">settings</span></button><button class="btn btn-icon settings-btn" style="margin-left: 8px;"><span class="material-symbols-rounded">settings</span></button><span class="material-symbols-rounded nav-arrow">arrow_forward</span></div></div>
                <p class="description">A privacy-focused Wikipedia frontend. Prevents cookie-based tracking and cross-site telemetry while providing an optimized reading environment.</p>
                <div class="chip-box"><span class="chip vpn portainer-link" data-container="wikiless" data-tooltip="Manage Wikiless Container"><span class="material-symbols-rounded">vpn_lock</span> Private Instance</span>
            </div>
            <div id="link-memos" data-url="http://10.0.1.204:5230" class="card" data-check="true" data-container="memos" onclick="navigate(this, event)">
                <div class="card-header"><h2>Memos</h2><div style="display: flex; align-items: center; gap: 12px;"><div class="status-indicator"><span class="status-dot"></span><span class="status-text">Initializing...</span></div><button onclick="openServiceSettings('memos', event)" class="btn btn-icon settings-btn" data-tooltip="Service Management & Metrics"><span class="material-symbols-rounded">settings</span></button><button class="btn btn-icon settings-btn" style="margin-left: 8px;"><span class="material-symbols-rounded">settings</span></button><span class="material-symbols-rounded nav-arrow">arrow_forward</span></div></div>
                <p class="description">A private notes and knowledge base. Capture ideas, snippets, and personal documentation without third-party tracking.</p>
                <div class="chip-box">
                    <span class="chip admin portainer-link" data-container="memos" data-tooltip="Manage Memos Container"><span class="material-symbols-rounded">lan</span> Direct Access</span>
                    <button onclick="vacuumServiceDb('memos', event)" class="chip admin" style="cursor:pointer; border:none;" data-tooltip="Optimize the database by reclaiming unused space (VACUUM). Highly recommended after large deletions."><span class="material-symbols-rounded">compress</span> Optimize DB</button>
                
            </div>
            <div id="link-rimgo" data-url="http://10.0.1.204:3002" class="card" data-check="true" data-container="rimgo" onclick="navigate(this, event)">
                <div class="card-header"><h2>Rimgo</h2><div style="display: flex; align-items: center; gap: 12px;"><div class="status-indicator"><span class="status-dot"></span><span class="status-text">Initializing...</span></div><button onclick="openServiceSettings('rimgo', event)" class="btn btn-icon settings-btn" data-tooltip="Service Management & Metrics"><span class="material-symbols-rounded">settings</span></button><button class="btn btn-icon settings-btn" style="margin-left: 8px;"><span class="material-symbols-rounded">settings</span></button><span class="material-symbols-rounded nav-arrow">arrow_forward</span></div></div>
                <p class="description">An anonymous Imgur viewer that removes telemetry and tracking scripts. Access visual content without facilitating behavioral profiling.</p>
                <div class="chip-box"><span class="chip vpn portainer-link" data-container="rimgo" data-tooltip="Manage Rimgo Container"><span class="material-symbols-rounded">vpn_lock</span> Private Instance</span>
            </div>
            <div id="link-scribe" data-url="http://10.0.1.204:8280" class="card" data-check="true" data-container="scribe" onclick="navigate(this, event)">
                <div class="card-header"><h2>Scribe</h2><div style="display: flex; align-items: center; gap: 12px;"><div class="status-indicator"><span class="status-dot"></span><span class="status-text">Initializing...</span></div><button onclick="openServiceSettings('scribe', event)" class="btn btn-icon settings-btn" data-tooltip="Service Management & Metrics"><span class="material-symbols-rounded">settings</span></button><button class="btn btn-icon settings-btn" style="margin-left: 8px;"><span class="material-symbols-rounded">settings</span></button><span class="material-symbols-rounded nav-arrow">arrow_forward</span></div></div>
                <p class="description">An alternative Medium frontend. Bypasses paywalls and eliminates tracking scripts to provide direct access to long-form content.</p>
                <div class="chip-box"><span class="chip vpn portainer-link" data-container="scribe" data-tooltip="Manage Scribe Container"><span class="material-symbols-rounded">vpn_lock</span> Private Instance</span>
            </div>
            <div id="link-breezewiki" data-url="http://10.0.1.204:8380/" class="card" data-check="true" data-container="breezewiki" onclick="navigate(this, event)">
                <div class="card-header"><h2>BreezeWiki</h2><div style="display: flex; align-items: center; gap: 12px;"><div class="status-indicator"><span class="status-dot"></span><span class="status-text">Initializing...</span></div><button onclick="openServiceSettings('breezewiki', event)" class="btn btn-icon settings-btn" data-tooltip="Service Management & Metrics"><span class="material-symbols-rounded">settings</span></button><button class="btn btn-icon settings-btn" style="margin-left: 8px;"><span class="material-symbols-rounded">settings</span></button><span class="material-symbols-rounded nav-arrow">arrow_forward</span></div></div>
                <p class="description">A clean interface for Fandom. Neutralizes aggressive advertising networks and tracking scripts that compromise standard browsing security.</p>
                <div class="chip-box"><span class="chip vpn portainer-link" data-container="breezewiki" data-tooltip="Manage BreezeWiki Container"><span class="material-symbols-rounded">vpn_lock</span> Private Instance</span>
            </div>
            <div id="link-anonymousoverflow" data-url="http://10.0.1.204:8480" class="card" data-check="true" data-container="anonymousoverflow" onclick="navigate(this, event)">
                <div class="card-header"><h2>AnonOverflow</h2><div style="display: flex; align-items: center; gap: 12px;"><div class="status-indicator"><span class="status-dot"></span><span class="status-text">Initializing...</span></div><button onclick="openServiceSettings('anonymousoverflow', event)" class="btn btn-icon settings-btn" data-tooltip="Service Management & Metrics"><span class="material-symbols-rounded">settings</span></button><button class="btn btn-icon settings-btn" style="margin-left: 8px;"><span class="material-symbols-rounded">settings</span></button><span class="material-symbols-rounded nav-arrow">arrow_forward</span></div></div>
                <p class="description">A private StackOverflow interface. Facilitates information retrieval for developers without facilitating cross-site corporate surveillance.</p>
                <div class="chip-box"><span class="chip vpn portainer-link" data-container="anonymousoverflow" data-tooltip="Manage AnonOverflow Container"><span class="material-symbols-rounded">vpn_lock</span> Private Instance</span>
            </div>
            <div id="link-vert" data-url="http://10.0.1.204:5555" class="card" data-check="true" data-container="vert" onclick="navigate(this, event)">
                <div class="card-header"><h2>VERT</h2><div style="display: flex; align-items: center; gap: 12px;"><div class="status-indicator"><span class="status-dot"></span><span class="status-text">Initializing...</span></div><button onclick="openServiceSettings('vert', event)" class="btn btn-icon settings-btn" data-tooltip="Service Management & Metrics"><span class="material-symbols-rounded">settings</span></button><button class="btn btn-icon settings-btn" style="margin-left: 8px;"><span class="material-symbols-rounded">settings</span></button><span class="material-symbols-rounded nav-arrow">arrow_forward</span></div></div>
                <p class="description">Local file conversion service. Maintains data autonomy by processing sensitive documents on your own hardware using GPU acceleration.</p>
                <div class="chip-box"><span class="chip admin portainer-link" data-container="vert" data-tooltip="Manage VERT Container"><span class="material-symbols-rounded">build</span> Utility</span><span class="chip tertiary" data-tooltip="Utilizes local GPU (/dev/dri) for high-performance conversion"><span class="material-symbols-rounded">memory</span> GPU Accelerated</span>
            </div>
        </div>

        <div class="section-label">System Management</div>
        <div class="section-hint" style="display: flex; gap: 8px; flex-wrap: wrap;">
            <span class="chip category-badge" data-tooltip="Core infrastructure management and gateway orchestration"><span class="material-symbols-rounded">settings_input_component</span> Core Services</span>
        </div>
        <div class="grid-3">
            <div id="link-adguard" data-url="http://10.0.1.204:8083" class="card" data-check="true" data-container="adguard" onclick="navigate(this, event)">
                <div class="card-header"><h2>AdGuard Home</h2><div style="display: flex; align-items: center; gap: 12px;"><div class="status-indicator"><span class="status-dot"></span><span class="status-text">Initializing...</span></div><button onclick="openServiceSettings('adguard', event)" class="btn btn-icon settings-btn" data-tooltip="Service Management & Metrics"><span class="material-symbols-rounded">settings</span></button><button class="btn btn-icon settings-btn" style="margin-left: 8px;"><span class="material-symbols-rounded">settings</span></button><span class="material-symbols-rounded nav-arrow">arrow_forward</span></div></div>
                <p class="description">Network-wide advertisement and tracker filtration. Centralizes DNS management to prevent data leakage at the source and ensure complete visibility of network traffic.</p>
                <div class="chip-box">
                    <span class="chip admin portainer-link" data-container="adguard" data-tooltip="Manage AdGuard Container"><span class="material-symbols-rounded">home</span> Local Access</span>
                    <button onclick="clearServiceLogs('adguard', event)" class="chip admin" style="cursor:pointer; border:none;" data-tooltip="Clear the historical DNS query logs to free up space."><span class="material-symbols-rounded">auto_delete</span> Clear Logs</button>
                    <span class="chip tertiary" data-tooltip="DNS-over-HTTPS/TLS/QUIC support enabled">Encrypted DNS</span>
                
            </div>
            <div id="link-portainer" data-url="http://10.0.1.204:9000" class="card" data-check="true" data-container="portainer" onclick="navigate(this, event)">
                <div class="card-header"><h2>Portainer</h2><div style="display: flex; align-items: center; gap: 12px;"><div class="status-indicator"><span class="status-dot"></span><span class="status-text">Initializing...</span></div><button onclick="openServiceSettings('portainer', event)" class="btn btn-icon settings-btn" data-tooltip="Service Management & Metrics"><span class="material-symbols-rounded">settings</span></button><button class="btn btn-icon settings-btn" style="margin-left: 8px;"><span class="material-symbols-rounded">settings</span></button><span class="material-symbols-rounded nav-arrow">arrow_forward</span></div></div>
                <p class="description">A comprehensive management interface for the Docker environment. Facilitates granular control over container orchestration and infrastructure lifecycle management.</p>
                <div class="chip-box"><span class="chip admin portainer-link" data-container="portainer" data-tooltip="Manage Portainer Container"><span class="material-symbols-rounded">home</span> Local Access</span>
            </div>
            <div id="link-wg-easy" data-url="http://10.0.1.204:51821" class="card" data-check="true" data-container="wg-easy" onclick="navigate(this, event)">
                <div class="card-header"><h2>WireGuard</h2><div style="display: flex; align-items: center; gap: 12px;"><div class="status-indicator"><span class="status-dot"></span><span class="status-text">Initializing...</span></div><button onclick="openServiceSettings('wg-easy', event)" class="btn btn-icon settings-btn" data-tooltip="Service Management & Metrics"><span class="material-symbols-rounded">settings</span></button><button class="btn btn-icon settings-btn" style="margin-left: 8px;"><span class="material-symbols-rounded">settings</span></button><span class="material-symbols-rounded nav-arrow">arrow_forward</span></div></div>
                <p class="description">The primary gateway for <strong>secure remote access</strong>. Provides a cryptographically sound tunnel to your home network, maintaining your privacy boundary on external networks.</p>
                <div class="chip-box"><span class="chip admin portainer-link" data-container="wg-easy" data-tooltip="Manage WireGuard Container"><span class="material-symbols-rounded">home</span> Local Access</span>
            </div>
        </div>

        <div class="section-label">DNS Configuration</div>
        <div class="grid-2">
            <div class="card">
                <h3>Certificate Status</h3>
                <div id="cert-status-content" style="padding-top: 12px; flex-grow: 1;">
                    <div class="stat-row" data-tooltip="Type of SSL certificate currently installed"><span class="stat-label">Type</span><span class="stat-value" id="cert-type">Loading...</span></div>
                    <div class="stat-row" data-tooltip="The domain name this certificate protects"><span class="stat-label">Domain</span><span class="stat-value sensitive" id="cert-subject">Loading...</span></div>
                    <div class="stat-row" data-tooltip="The authority that issued this certificate"><span class="stat-label">Issuer</span><span class="stat-value sensitive" id="cert-issuer">Loading...</span></div>
                    <div class="stat-row" data-tooltip="Date when this certificate will expire"><span class="stat-label">Expires</span><span class="stat-value sensitive" id="cert-to">Loading...</span></div>
                    <div id="ssl-failure-info" style="display:none; margin-top: 16px; padding: 16px; border-radius: var(--md-sys-shape-corner-medium); background: var(--md-sys-color-error-container); color: var(--md-sys-color-on-error-container); border: 1px solid var(--md-sys-color-error);">
                        <div class="body-small" style="font-weight:600; margin-bottom:4px; display: flex; align-items: center; gap: 8px;">
                            <span class="material-symbols-rounded" style="font-size: 16px;">error</span>
                            Pipeline Error
                        </div>
                        <div class="body-small" id="ssl-failure-reason" style="opacity: 0.9;">--</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 24px; gap: 16px; flex-wrap: wrap;">
                    <div id="cert-status-badge" class="chip" style="width: fit-content;" data-tooltip="Overall health of the SSL certificate issuance pipeline">...</div>
                    <button id="ssl-retry-btn" class="btn btn-icon btn-action" style="display:none;" data-tooltip="Force Let's Encrypt re-attempt" onclick="requestSslCheck()">
                        <span class="material-symbols-rounded">refresh</span>
                    </button>
                </div>
            </div>
            <div class="card">
                <h3>deSEC Configuration</h3>
                <p class="body-medium description">Manage your dynamic DNS and SSL certificate parameters:</p>
                <form onsubmit="saveDesecConfig(); return false;">
                    <input type="text" id="desec-domain-input" class="text-field" placeholder="Domain (e.g. yourname.dedyn.io)" style="margin-bottom:12px;" autocomplete="username" data-tooltip="Enter your registered deSEC domain (e.g. yourname.dedyn.io). You can create one for free at desec.io.">
                    <input type="password" id="desec-token-input" class="text-field sensitive" placeholder="deSEC API Token" style="margin-bottom:12px;" autocomplete="current-password" data-tooltip="The secret API token from your deSEC account used to verify domain ownership.">
                    <p class="body-small" style="margin-bottom:16px; color: var(--md-sys-color-on-surface-variant);">
                        Get your domain and token at <a href="https://desec.io" target="_blank" style="color: var(--md-sys-color-primary);">desec.io</a>.
                    </p>
                    <div style="text-align:right;">
                        <button type="submit" class="btn btn-tonal">Save deSEC Config</button>
                    </div>
                </form>
            </div>
            <div class="card">
                <h3>Device DNS Settings</h3>
                <p class="body-medium description">Utilize these RFC-compliant encrypted endpoints to maintain digital independence:</p>
                <div class="code-label" data-tooltip="Standard unencrypted DNS (Port 53). Recommended only for use within your local LAN.">Standard IPv4 (Local LAN Only)</div>
                <div class="code-block sensitive">10.0.1.204:53</div>
                <div class="code-label" data-tooltip="DNS-over-QUIC (DOQ) - RFC 9250. Port 853. High-performance encrypted DNS designed for superior latency and stability.">Secure DOQ (Modern Clients)</div>
                <div class="code-block sensitive">quic://10.0.1.204</div>
                <div class="code-label" data-tooltip="Secured DNS via HTTPS">DNS-over-HTTPS</div>
                <div class="code-block sensitive">https://10.0.1.204/dns-query</div>
                <div class="code-label" data-tooltip="Secured DNS via TLS">DNS-over-TLS</div>
                <div class="code-block sensitive">10.0.1.204:853</div>
            </div>
            <div class="card">
                <h3>Endpoint Provisioning</h3>
                <p class="body-medium description">Infrastructure access model:</p>
                <ol style="margin:0; padding-left:20px; font-size:14px; color:var(--md-sys-color-on-surface); line-height:1.8;">
                    <li>Configure router WAN/LAN DNS: <b class="sensitive">10.0.1.204</b></li>
                    <li>Remote Access: Utilize WireGuard VPN interface</li>
                </ol>
                <div class="code-block sensitive" style="margin-top:12px;">10.0.1.204</div>
                <div style="margin-top: auto; padding-top: 16px;">
                    <div class="chip admin" style="width: 100%; justify-content: flex-start; gap: 12px; height: auto; padding: 12px; border-radius: var(--md-sys-shape-corner-medium);">
                        <span class="material-symbols-rounded" style="color: var(--md-sys-color-on-secondary-container);">warning</span>
                        <div style="display: flex; flex-direction: column; gap: 2px;">
                            <span style="font-weight: 600;">Self-Signed (Local)</span>
                            <span class="body-small" style="opacity: 0.8; white-space: normal;">Security warnings will appear. Configure deSEC for trusted SSL.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-label">Odido Bundle Booster</div>
        <div class="grid-2">
            <div class="card">
                <h3>Data Status</h3>
                <div id="odido-status-container">
                    <div id="odido-not-configured" style="display:none;">
                        <p class="body-medium" style="color:var(--md-sys-color-on-surface-variant);">Odido Bundle Booster service available. Configure credentials via API or link below.</p>
                        <a href="http://10.0.1.204:8085/docs" target="_blank" class="btn btn-tonal" style="margin-top:12px;">Open API Docs</a>
                    </div>
                    <div id="odido-configured" style="display:none; padding-top: 8px;">
                        <div class="stat-row"><span class="stat-label">Data Remaining</span><span class="stat-value" id="odido-remaining">--</span></div>
                        <div class="stat-row"><span class="stat-label">Bundle Code</span><span class="stat-value" id="odido-bundle-code">--</span></div>
                        <div class="stat-row"><span class="stat-label">Auto-Renew</span><span class="stat-value" id="odido-auto-renew">--</span></div>
                        <div class="stat-row"><span class="stat-label">Threshold</span><span class="stat-value" id="odido-threshold">--</span></div>
                        <div class="stat-row"><span class="stat-label">Consumption Rate</span><span class="stat-value" id="odido-rate">--</span></div>
                        <div class="stat-row"><span class="stat-label">API Status</span><span class="stat-value" id="odido-api-status">--</span></div>
                        <div class="btn-group" style="justify-content:center;">
                            <button onclick="buyOdidoBundle()" class="btn btn-tertiary" id="odido-buy-btn">Buy Bundle</button>
                            <button onclick="refreshOdidoRemaining()" class="btn btn-tonal">Refresh</button>
                            <a href="http://10.0.1.204:8085/docs" target="_blank" class="btn btn-outlined">API</a>
                        </div>
                    </div>
                    <div id="odido-loading" style="color:var(--md-sys-color-on-surface-variant);">Loading...</div>
                </div>
            </div>
            <div class="card">
                <h3>Configuration</h3>
                <p class="body-medium description">Authentication and automation settings for backend services:</p>
                <form onsubmit="saveOdidoConfig(); return false;">
                    <input type="text" id="odido-api-key" class="text-field sensitive" placeholder="Dashboard API Key" style="margin-bottom:12px;" autocomplete="username" data-tooltip="The HUB_API_KEY from your .secrets file.">
                    <p class="body-small" style="margin-bottom:16px; color: var(--md-sys-color-on-surface-variant);">
                        The <strong>Dashboard API Key</strong> (HUB_API_KEY) is required to authorize sensitive actions like saving settings. You can find this in your <code>.secrets</code> file on the host.
                    </p>
                    <input type="password" id="odido-oauth-token" class="text-field sensitive" placeholder="Odido OAuth Token" style="margin-bottom:12px;" autocomplete="current-password" data-tooltip="OAuth token for Odido API authentication.">
                    <p class="body-small" style="margin-bottom:16px; color: var(--md-sys-color-on-surface-variant);">
                        Obtain your OAuth token using the <a href="https://github.com/GuusBackup/Odido.Authenticator" target="_blank" style="color: var(--md-sys-color-primary);">Odido Authenticator</a>.
                    </p>
                    <input type="text" id="odido-bundle-code-input" class="text-field" placeholder="Bundle Code (default: A0DAY01)" style="margin-bottom:12px;" data-tooltip="The product code for your data bundle.">
                    <input type="number" id="odido-threshold-input" class="text-field" placeholder="Min Threshold MB (default: 100)" style="margin-bottom:12px;" data-tooltip="Automatic renewal triggers when data falls below this level.">
                    <input type="number" id="odido-lead-time-input" class="text-field" placeholder="Lead Time Minutes (default: 30)" style="margin-bottom:12px;" data-tooltip="Minutes before expiration to trigger renewal.">
                    <div style="text-align:right;">
                        <button type="submit" class="btn btn-tonal">Save Configuration</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="section-label">WireGuard Profiles</div>
        <div class="grid-2">
            <div class="card">
                <h3>Upload Profile</h3>
                <input type="text" id="prof-name" class="text-field" placeholder="Optional: Custom Name" style="margin-bottom:12px;" data-tooltip="Give your profile a recognizable name.">
                <textarea id="prof-conf" class="text-field sensitive" placeholder="Paste .conf content here..." style="margin-bottom:16px;" data-tooltip="Paste the contents of your WireGuard .conf file."></textarea>
                <div style="text-align:right;"><button onclick="uploadProfile()" class="btn btn-filled" data-tooltip="Save this profile. The VPN service will automatically restart to apply the new configuration (~15 seconds).">Upload & Activate</button></div>
            </div>
            <div class="card profile-card">
                <h3 data-tooltip="Select a profile to activate it. The dashboard will automatically restart dependent services to route their traffic through the new tunnel.">Available Profiles</h3>
                <div id="profile-list" style="flex-grow: 1;">Loading...</div>
                <p class="body-small profile-hint" style="margin-top: auto; padding-top: 12px;">Click name to activate.</p>
            </div>
        </div>

        <div class="section-label">System & Logs</div>
        <div class="grid-2">
            <div class="card">
                <h3>System Information</h3>
                <p class="body-medium description">Sensitive credentials and core configuration details are stored securely on the host filesystem:</p>
                <div class="stat-row"><span class="stat-label">Secrets Location</span><span class="stat-value monospace">/DATA/AppData/privacy-hub/.secrets</span></div>
                <div class="stat-row"><span class="stat-label">Config Root</span><span class="stat-value monospace">/DATA/AppData/privacy-hub/config</span></div>
                <div class="stat-row"><span class="stat-label">Dashboard Port</span><span class="stat-value">8081</span></div>
                <div class="stat-row"><span class="stat-label">Safe Display</span><span class="stat-value">Active (Client-side)</span></div>
                <div style="margin-top: 24px; display: flex; flex-direction: column; gap: 12px;">
                    <button onclick="restartStack()" class="btn btn-filled" style="width: 100%; background: var(--md-sys-color-error-container); color: var(--md-sys-color-on-error-container);" data-tooltip="Reboot all containers in the stack. This takes ~30 seconds and is required for manual .secrets changes to take effect.">
                        <span class="material-symbols-rounded">restart_alt</span>
                        Restart Stack
                    </button>
                    <button onclick="rotateApiKey()" class="btn btn-tonal" style="width: 100%;" data-tooltip="Update the HUB_API_KEY used for dashboard authentication.">
                        <span class="material-symbols-rounded">key_visualizer</span>
                        Rotate API Key
                    </button>
                    <p class="body-small" style="color: var(--md-sys-color-on-surface-variant);">
                        Note: Changes to .secrets may require a stack restart to take full effect.
                    </p>
                </div>
                <p class="body-small" style="margin-top: auto; padding-top: 16px; color: var(--md-sys-color-on-surface-variant);">
                    See the <a href="https://github.com/Lyceris-chan/selfhost-stack#credentials" target="_blank" style="color: var(--md-sys-color-primary);">README</a> for full details on obtaining required credentials.
                </p>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3>System & Deployment Logs</h3>
                    <div style="display: flex; gap: 8px;">
                        <select id="log-filter-level" onchange="filterLogs()" class="btn btn-tonal" style="height: 32px; padding: 0 8px; font-size: 12px; border-radius: 8px;">
                            <option value="ALL">All Levels</option>
                            <option value="INFO">Info</option>
                            <option value="WARN">Warn</option>
                            <option value="ERROR">Error</option>
                            <option value="SECURITY">Security</option>
                        </select>
                        <select id="log-filter-cat" onchange="filterLogs()" class="btn btn-tonal" style="height: 32px; padding: 0 8px; font-size: 12px; border-radius: 8px;">
                            <option value="ALL">All Categories</option>
                            <option value="SYSTEM">System</option>
                            <option value="NETWORK">Network</option>
                            <option value="MAINTENANCE">Maintenance</option>
                        </select>
                    </div>
                </div>
                <div id="log-container" class="log-container sensitive">Loading logs...</div>
                <div id="log-status" class="body-small" style="color:var(--md-sys-color-on-surface-variant); text-align:right; margin-top:8px;">Connecting...</div>
            </div>
        </div>
    </div>

    <!-- Setup Wizard -->
    <div id="setup-wizard" class="wizard-overlay">
        <!-- ... existing ... -->
    </div>

    <!-- Service Management Modal -->
    <div id="service-modal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h2 id="modal-service-name">Service Settings</h2>
                <button onclick="closeServiceModal()" class="btn btn-icon"><span class="material-symbols-rounded">close</span></button>
            </div>
            <div id="modal-metrics" style="background: var(--md-sys-color-surface-container-low); padding: 16px; border-radius: 12px;">
                <div class="stat-row"><span class="stat-label">CPU Usage</span><span class="stat-value" id="modal-cpu">0%</span></div>
                <div class="metric-bar"><div id="modal-cpu-fill" class="metric-fill" style="width: 0%"></div></div>
                <div class="stat-row" style="margin-top:12px;"><span class="stat-label">Memory</span><span class="stat-value" id="modal-mem">0 / 0 MB</span></div>
                <div class="metric-bar"><div id="modal-mem-fill" class="metric-fill" style="width: 0%"></div></div>
            </div>
            <div id="modal-actions" class="btn-group" style="flex-direction: column; gap: 8px;">
                <!-- Actions injected via JS -->
            </div>
        </div>
    </div>

    <script>
        const API = "http://10.0.1.204:8081/api";
        const ODIDO_API = "http://10.0.1.204:8081/odido-api/api";
        
        function getPortainerBaseUrl() {
            if (window.location.hostname !== '10.0.1.204' && !window.location.hostname.match(/^\d+\.\d+\.\d+\.\d+$/)) {
                // We are likely on a domain (e.g. hub.example.com)
                // Try to infer portainer subdomain based on the current hostname
                const parts = window.location.hostname.split('.');
                if (parts.length >= 2) {
                    const domain = parts.slice(-2).join('.');
                    const port = window.location.port ? ":" + window.location.port : "";
                    return "https://portainer." + domain + port;
                }
            }
            return "http://10.0.1.204:9000";
        }

        const PORTAINER_URL = getPortainerBaseUrl();
        const DEFAULT_ODIDO_API_KEY = "rS5WwUBg6XG6MO1Lmk4ROn3AMDfNnsi6";
        let storedOdidoKey = localStorage.getItem('odido_api_key');
        // Ensure the dashboard always uses the latest deployment key
        if (DEFAULT_ODIDO_API_KEY && storedOdidoKey && storedOdidoKey !== DEFAULT_ODIDO_API_KEY) {
            localStorage.setItem('odido_api_key', DEFAULT_ODIDO_API_KEY);
            storedOdidoKey = DEFAULT_ODIDO_API_KEY;
        }
        let odidoApiKey = storedOdidoKey || DEFAULT_ODIDO_API_KEY;
        let containerIds = {};
        let pendingUpdates = [];

        async function fetchUpdates() {
            try {
                const res = await fetch(API + "/updates");
                if (!res.ok) return;
                const data = await res.json();
                const updates = data.updates || {};
                pendingUpdates = Object.keys(updates);
                
                const banner = document.getElementById('update-banner');
                const list = document.getElementById('update-list');
                
                if (pendingUpdates.length > 0) {
                    banner.style.display = 'block';
                    list.textContent = "Updates available for: " + pendingUpdates.join(", ");
                } else {
                    banner.style.display = 'none';
                }
            } catch(e) {}
        }

        async function updateAllServices() {
            if (!confirm("Update " + pendingUpdates.length + " services now? This will pull latest code and rebuild containers.")) return;
            for (const srv of pendingUpdates) {
                await updateService(srv);
            }
            alert("All updates completed.");
            fetchUpdates();
        }

        async function updateService(name) {
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (odidoApiKey) headers['X-API-Key'] = odidoApiKey;
                const res = await fetch(API + "/update-service", {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ service: name })
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                return true;
            } catch(e) {
                alert("Failed to update " + name + ": " + e.message);
                return false;
            }
        }

        async function migrateService(name, event) {
            if (event) { event.preventDefault(); event.stopPropagation(); }
            const doBackup = document.getElementById('invidious-backup-toggle')?.checked ? 'yes' : 'no';
            if (!confirm("Run foolproof migration for " + name + "?" + (doBackup === 'yes' ? " This will create a database backup first." : " WARNING: No backup will be created."))) return;
            try {
                const res = await fetch(API + "/migrate?service=" + name + "&backup=" + doBackup);
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                alert("Migration successful!\n\n" + data.output);
            } catch(e) {
                alert("Migration failed: " + e.message);
            }
        }

        async function clearServiceDb(name, event) {
            if (event) { event.preventDefault(); event.stopPropagation(); }
            const doBackup = document.getElementById('invidious-backup-toggle')?.checked ? 'yes' : 'no';
            if (!confirm("DANGER: This will permanently DELETE all subscriptions and preferences for " + name + "." + (doBackup === 'yes' ? " A backup will be created first." : " WARNING: NO BACKUP WILL BE CREATED.") + " Continue?")) return;
            try {
                const res = await fetch(API + "/clear-db?service=" + name + "&backup=" + doBackup);
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                alert("Database cleared successfully!\n\n" + data.output);
            } catch(e) {
                showSnackbar("Action failed: " + e.message);
            }
        }

        async function clearServiceLogs(name, event) {
            if (event) { event.preventDefault(); event.stopPropagation(); }
            if (!confirm("Clear all historical query logs for " + name + "? This cannot be undone.")) return;
            try {
                const res = await fetch(API + "/clear-logs?service=" + name);
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                showSnackbar("Logs cleared successfully!");
            } catch(e) {
                showSnackbar("Failed to clear logs: " + e.message);
            }
        }

        async function vacuumServiceDb(name, event) {
            if (event) { event.preventDefault(); event.stopPropagation(); }
            showSnackbar("Optimizing database... please wait.");
            try {
                const res = await fetch(API + "/vacuum?service=" + name);
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                showSnackbar("Database optimized successfully!");
            } catch(e) {
                showSnackbar("Optimization failed: " + e.message);
            }
        }
        
        async function rotateApiKey() {
            const newKey = prompt("Enter new HUB_API_KEY. Warning: You must update your local .secrets manually if this fails!");
            if (!newKey) return;
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (odidoApiKey) headers['X-API-Key'] = odidoApiKey;
                const res = await fetch(API + "/rotate-api-key", {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ new_key: newKey })
                });
                const data = await res.json();
                if (data.success) {
                    odidoApiKey = newKey;
                    localStorage.setItem('odido_api_key', newKey);
                    showSnackbar("API Key rotated successfully!");
                } else { throw new Error(data.error); }
            } catch(e) { showSnackbar("Rotation failed: " + e.message); }
        }

        async function filterLogs() {
            const level = document.getElementById('log-filter-level').value;
            const category = document.getElementById('log-filter-cat').value;
            let url = API + "/logs";
            const params = [];
            if (level !== 'ALL') params.push("level=" + level);
            if (category !== 'ALL') params.push("category=" + category);
            if (params.length) url += "?" + params.join("&");
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                const el = document.getElementById('log-container');
                el.innerHTML = '';
                (data.logs || []).forEach(log => {
                    el.appendChild(parseLogLine(JSON.stringify(log)));
                });
            } catch(e) { showSnackbar("Failed to filter logs"); }
        }
        
        async function fetchContainerIds() {
            try {
                const res = await fetch(API + "/containers");
                if (!res.ok) throw new Error("API " + res.status);
                const data = await res.json();
                containerIds = data.containers || {};
                
                // Update all portainer links
                document.querySelectorAll('.portainer-link').forEach(el => {
                    const containerName = el.dataset.container;
                    const cid = containerIds[containerName];
                    const originalText = el.getAttribute('data-original-text') || el.textContent.trim();
                    if (!el.getAttribute('data-original-text')) el.setAttribute('data-original-text', originalText);

                    if (cid) {
                        el.style.opacity = '1';
                        el.style.cursor = 'pointer';
                        el.dataset.tooltip = "Manage " + containerName + " in Portainer";
                        el.innerHTML = originalText + ' <svg style="width:16px; height:16px; vertical-align:middle; margin-left:4px; fill:currentColor; pointer-events:none;" viewBox="0 0 24 24"><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>';
                        
                        // Use a fresh onclick handler
                        el.onclick = function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            const url = PORTAINER_URL + "/#!/1/docker/containers/" + cid;
                            window.open(url, '_blank');
                            return false;
                        };
                    } else {
                        el.style.opacity = '0.5';
                        el.style.cursor = 'default';
                        el.dataset.tooltip = "Container " + containerName + " not found";
                        el.textContent = originalText;
                        el.onclick = (e) => { 
                            e.preventDefault(); 
                            e.stopPropagation(); 
                            e.stopImmediatePropagation();
                        };
                    }
                });
            } catch(e) { console.error('Container fetch error:', e); }
        }
        
        // Store real profile name for privacy mode masking
        let realProfileName = '';
        let maskedProfileId = '';
        const profileMaskMap = {};
        
        function navigate(el, e) {
            if (e && (e.target.closest('.portainer-link') || e.target.closest('.btn') || e.target.closest('.chip'))) return;
            const url = el.getAttribute('data-url');
            if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
                window.open(url, '_blank');
            }
        }

        function generateRandomId() {
            const chars = 'abcdef0123456789';
            let id = '';
            for (let i = 0; i < 8; i++) id += chars.charAt(Math.floor(Math.random() * chars.length));
            return 'profile-' + id;
        }
        
        function updateProfileDisplay() {
            const vpnActive = document.getElementById('vpn-active');
            const isPrivate = document.body.classList.contains('privacy-mode');
            if (vpnActive && realProfileName) {
                if (isPrivate) {
                    if (!maskedProfileId) maskedProfileId = generateRandomId();
                    vpnActive.textContent = maskedProfileId;
                    vpnActive.classList.add('sensitive-masked');
                } else {
                    vpnActive.textContent = realProfileName;
                    vpnActive.classList.remove('sensitive-masked');
                }
            }
            updateProfileListDisplay();
        }

        function getProfileLabel(name) {
            const isPrivate = document.body.classList.contains('privacy-mode');
            if (!isPrivate) return name;
            if (!profileMaskMap[name]) profileMaskMap[name] = generateRandomId();
            return profileMaskMap[name];
        }

        function updateProfileListDisplay() {
            const items = document.querySelectorAll('#profile-list .list-item-text');
            items.forEach((item) => {
                const realName = item.dataset.realName;
                if (realName) item.textContent = getProfileLabel(realName);
            });
        }
        
        async function saveDesecConfig() {
            const domain = document.getElementById('desec-domain-input').value.trim();
            const token = document.getElementById('desec-token-input').value.trim();
            if (!domain && !token) {
                showSnackbar("Please provide domain or token");
                return;
            }
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (odidoApiKey) headers['X-API-Key'] = odidoApiKey;
                const res = await fetch(API + "/config-desec", {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ domain, token })
                });
                const result = await res.json();
                if (result.success) {
                    showSnackbar("deSEC configuration saved! Certificates updating in background.");
                    document.getElementById('desec-domain-input').value = '';
                    document.getElementById('desec-token-input').value = '';
                } else {
                    throw new Error(result.error || "Unknown error");
                }
            } catch (e) {
                showSnackbar("Failed to save deSEC config: " + e.message);
            }
        }
        
        async function fetchStatus() {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            try {
                const res = await fetch(API + "/status", { signal: controller.signal });
                clearTimeout(timeoutId);
                
                if (res.status === 401) {
                    throw new Error("401 Unauthorized");
                }
                
                const data = await res.json();
                const setText = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                    return el;
                };
                const g = data.gluetun || {};
                const vpnStatus = document.getElementById('vpn-status');
                if (vpnStatus) {
                    if (g.status === "up" && g.healthy) {
                        vpnStatus.textContent = "Connected (Healthy)";
                        vpnStatus.className = "stat-value text-success";
                        vpnStatus.title = "VPN tunnel is active and passing health checks";
                    } else if (g.status === "up") {
                        vpnStatus.textContent = "Connected";
                        vpnStatus.className = "stat-value text-success";
                        vpnStatus.title = "VPN tunnel is active";
                    } else {
                        vpnStatus.textContent = "Disconnected";
                        vpnStatus.className = "stat-value error";
                        vpnStatus.title = "VPN tunnel is not established";
                    }
                }
                realProfileName = g.active_profile || "Unknown";
                updateProfileDisplay();
                setText('vpn-endpoint', g.endpoint || "--");
                setText('vpn-public-ip', g.public_ip || "--");
                setText('vpn-connection', g.handshake_ago || "Never");
                setText('vpn-session-rx', formatBytes(g.session_rx || 0));
                setText('vpn-session-tx', formatBytes(g.session_tx || 0));
                setText('vpn-total-rx', formatBytes(g.total_rx || 0));
                setText('vpn-total-tx', formatBytes(g.total_tx || 0));
                const w = data.wgeasy || {};
                const wgeStat = document.getElementById('wge-status');
                if (wgeStat) {
                    if (w.status === "up") {
                        wgeStat.textContent = "Running";
                        wgeStat.className = "stat-value text-success";
                        wgeStat.title = "WireGuard management service is operational";
                    } else {
                        wgeStat.textContent = "Stopped";
                        wgeStat.className = "stat-value error";
                        wgeStat.title = "WireGuard management service is not running";
                    }
                }
                setText('wge-host', w.host || "--");
                setText('wge-clients', w.clients || "0");
                const wgeConnected = document.getElementById('wge-connected');
                const connectedCount = parseInt(w.connected) || 0;
                if (wgeConnected) {
                    wgeConnected.textContent = connectedCount > 0 ? connectedCount + " active" : "None";
                    wgeConnected.className = connectedCount > 0 ? "stat-value text-success" : "stat-value";
                }
                setText('wge-session-rx', formatBytes(w.session_rx || 0));
                setText('wge-session-tx', formatBytes(w.session_tx || 0));
                setText('wge-total-rx', formatBytes(w.total_rx || 0));
                setText('wge-total-tx', formatBytes(w.total_tx || 0));

                // Update service statuses from server-side checks
                if (data.services) {
                    const statusLabels = {
                        'healthy': { text: 'Healthy', tip: 'Service is operational and passing health checks' },
                        'up': { text: 'Online', tip: 'Service is running but lacks specific health checks' },
                        'starting': { text: 'Starting', tip: 'Service is currently initializing' },
                        'unhealthy': { text: 'Unhealthy', tip: 'Service is running but failing health checks' },
                        'down': { text: 'Offline', tip: 'Service is stopped or unreachable' }
                    };

                    for (const [name, status] of Object.entries(data.services)) {
                        const card = document.getElementById("link-" + name);
                        if (card) {
                            const indicator = card.querySelector('.status-indicator');
                            const dot = card.querySelector('.status-dot');
                            const txt = card.querySelector('.status-text');
                            if (dot && txt && indicator) {
                                const info = statusLabels[status] || statusLabels['down'];
                                dot.className = "status-dot " + status;
                                txt.textContent = info.text;
                                
                                // Show detailed health info if unhealthy
                                let tooltip = info.tip;
                                if (status === 'unhealthy' && data.health_details && data.health_details[name]) {
                                    tooltip = "ERROR: " + data.health_details[name];
                                }
                                indicator.dataset.tooltip = tooltip;

                                // Apply text-success class if healthy or up
                                if (status === 'healthy' || status === 'up') {
                                    txt.classList.add('text-success');
                                } else {
                                    txt.classList.remove('text-success');
                                }
                            }
                            
                            // Update metrics chips if present
                            const metricsBox = document.getElementById("metrics-" + name);
                            if (metricsBox && containerMetrics[name]) {
                                const m = containerMetrics[name];
                                metricsBox.style.display = 'flex';
                                metricsBox.querySelector('.cpu-val').textContent = m.cpu.toFixed(0) + '%';
                                metricsBox.querySelector('.mem-val').textContent = Math.round(m.mem) + 'MB';
                            } else if (metricsBox) {
                                metricsBox.style.display = 'none';
                            }
                        }
                    }
                }
            } catch(e) { 
                console.error('Status fetch error:', e);
                // On error, mark all services as offline with reason
                const errorMsg = e.message && e.message.includes('401') ? "Offline (Unauthorized)" : "Offline (API Error)";
                document.querySelectorAll('.card[data-check="true"]').forEach(c => {
                    const dot = c.querySelector('.status-dot');
                    const txt = c.querySelector('.status-text');
                    if (dot && txt) {
                        dot.className = "status-dot down";
                        txt.textContent = errorMsg;
                        txt.classList.remove('text-success');
                    }
                });
            }
        }
        
        async function fetchOdidoStatus() {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            try {
                const headers = odidoApiKey ? { 'X-API-Key': odidoApiKey } : {};
                const res = await fetch(ODIDO_API + "/status", { headers, signal: controller.signal });
                clearTimeout(timeoutId);
                if (!res.ok) {
                    const data = await res.json().catch(() => ({}));
                    document.getElementById('odido-loading').style.display = 'none';
                    document.getElementById('odido-not-configured').style.display = 'none';
                    document.getElementById('odido-configured').style.display = 'block';
                    document.getElementById('odido-remaining').textContent = '--';
                    document.getElementById('odido-bundle-code').textContent = '--';
                    document.getElementById('odido-threshold').textContent = '--';
                    const apiStatus = document.getElementById('odido-api-status');
                    
                    if (res.status === 401) {
                        apiStatus.textContent = 'Dashboard API Key Invalid';
                        apiStatus.style.color = 'var(--md-sys-color-error)';
                    } else if (res.status === 400 || (data.detail && data.detail.includes('credentials'))) {
                        apiStatus.textContent = 'Odido Account Not Linked';
                        apiStatus.style.color = 'var(--md-sys-color-warning)';
                    } else {
                        apiStatus.textContent = "Service Error: " + res.status;
                        apiStatus.style.color = 'var(--md-sys-color-error)';
                    }
                    return;
                }
                const data = await res.json();
                document.getElementById('odido-loading').style.display = 'none';
                document.getElementById('odido-not-configured').style.display = 'none';
                document.getElementById('odido-configured').style.display = 'block';
                const state = data.state || {};
                const config = data.config || {};
                const remaining = state.remaining_mb || 0;
                const threshold = config.absolute_min_threshold_mb || 100;
                const rate = data.consumption_rate_mb_per_min || 0;
                const bundleCode = config.bundle_code || 'A0DAY01';
                const hasOdidoCreds = config.odido_user_id && config.odido_token;
                // Also consider as "connected" if we have real data from the API
                const hasRealData = remaining > 0 || state.last_updated_ts;
                const isConfigured = hasOdidoCreds || hasRealData;
                document.getElementById('odido-remaining').textContent = Math.round(remaining) + " MB";
                document.getElementById('odido-bundle-code').textContent = bundleCode;
                document.getElementById('odido-threshold').textContent = threshold + " MB";
                document.getElementById('odido-auto-renew').textContent = config.auto_renew_enabled ? 'Enabled' : 'Disabled';
                document.getElementById('odido-rate').textContent = rate.toFixed(3) + " MB/min";
                const apiStatus = document.getElementById('odido-api-status');
                apiStatus.textContent = isConfigured ? 'Connected' : 'Not configured';
                apiStatus.style.color = isConfigured ? 'var(--md-sys-color-success)' : 'var(--md-sys-color-warning)';
                const maxData = config.bundle_size_mb || 1024;
                const percent = Math.min(100, (remaining / maxData) * 100);
                const bar = document.getElementById('odido-bar');
                if (bar) {
                    bar.style.width = percent + "%";
                    bar.className = 'progress-indicator';
                    if (remaining < threshold) bar.classList.add('critical');
                    else if (remaining < threshold * 2) bar.classList.add('low');
                }
            } catch(e) {
                // Network error or service unavailable - show not-configured with error info
                const loading = document.getElementById('odido-loading');
                if (loading) loading.style.display = 'none';
                const notConf = document.getElementById('odido-not-configured');
                if (notConf) notConf.style.display = 'block';
                const conf = document.getElementById('odido-configured');
                if (conf) conf.style.display = 'none';
                console.error('Odido status error:', e);
            }
        }
        
        async function saveOdidoConfig() {
            const st = document.getElementById('odido-config-status');
            const data = {};
            const apiKey = document.getElementById('odido-api-key').value.trim();
            const oauthToken = document.getElementById('odido-oauth-token').value.trim();
            const bundleCode = document.getElementById('odido-bundle-code-input').value.trim();
            const threshold = document.getElementById('odido-threshold-input').value.trim();
            const leadTime = document.getElementById('odido-lead-time-input').value.trim();
            
            if (apiKey) {
                odidoApiKey = apiKey;
                localStorage.setItem('odido_api_key', apiKey);
                data.api_key = apiKey;
            }
            
            // If OAuth token provided, fetch User ID automatically via hub-api API (uses curl)
            if (oauthToken) {
                if (st) {
                    st.textContent = 'Fetching User ID from Odido API...';
                    st.style.color = 'var(--p)';
                }
                try {
                    const res = await fetch(API + "/odido-userid", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ oauth_token: oauthToken })
                    });
                    const result = await res.json();
                    if (result.error) throw new Error(result.error);
                    if (result.user_id) {
                        data.odido_user_id = result.user_id;
                        data.odido_token = oauthToken;
                        if (st) {
                            st.textContent = "User ID fetched: " + result.user_id;
                            st.style.color = 'var(--ok)';
                        }
                    } else {
                        throw new Error('Could not extract User ID from Odido API response');
                    }
                } catch(e) {
                    if (st) {
                        st.textContent = "Failed to fetch User ID: " + e.message;
                        st.style.color = 'var(--err)';
                    }
                    return;
                }
            }
            
            if (bundleCode) data.bundle_code = bundleCode;
            if (threshold) data.absolute_min_threshold_mb = parseInt(threshold);
            if (leadTime) data.lead_time_minutes = parseInt(leadTime);
            
            if (Object.keys(data).length === 0) {
                if (st) {
                    st.textContent = 'Please fill in at least one field';
                    st.style.color = 'var(--err)';
                }
                return;
            }
            if (st) {
                st.textContent = 'Saving configuration...';
                st.style.color = 'var(--p)';
            }
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (odidoApiKey) headers['X-API-Key'] = odidoApiKey;
                const res = await fetch(ODIDO_API + "/config", {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.detail) throw new Error(result.detail);
                if (st) {
                    st.textContent = 'Configuration saved!';
                    st.style.color = 'var(--ok)';
                }
                document.getElementById('odido-api-key').value = '';
                document.getElementById('odido-oauth-token').value = '';
                document.getElementById('odido-bundle-code-input').value = '';
                document.getElementById('odido-threshold-input').value = '';
                document.getElementById('odido-lead-time-input').value = '';
                fetchOdidoStatus();
            } catch(e) {
                if (st) {
                    st.textContent = e.message;
                    st.style.color = 'var(--err)';
                }
            }
        }
        
        async function buyOdidoBundle() {
            const st = document.getElementById('odido-buy-status');
            const btn = document.getElementById('odido-buy-btn');
            btn.disabled = true;
            if (st) {
                st.textContent = 'Purchasing bundle from Odido...';
                st.style.color = 'var(--p)';
            }
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (odidoApiKey) headers['X-API-Key'] = odidoApiKey;
                const res = await fetch(ODIDO_API + "/odido/buy-bundle", {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({})
                });
                const result = await res.json();
                if (result.detail) throw new Error(result.detail);
                if (st) {
                    st.textContent = 'Bundle purchased successfully!';
                    st.style.color = 'var(--ok)';
                }
                setTimeout(fetchOdidoStatus, 2000);
            } catch(e) {
                if (st) {
                    st.textContent = e.message;
                    st.style.color = 'var(--err)';
                }
            }
            btn.disabled = false;
        }
        
        async function refreshOdidoRemaining() {
            const st = document.getElementById('odido-buy-status');
            if (st) {
                st.textContent = 'Fetching from Odido API...';
                st.style.color = 'var(--p)';
            }
            try {
                const headers = {};
                if (odidoApiKey) headers['X-API-Key'] = odidoApiKey;
                const res = await fetch(ODIDO_API + "/odido/remaining", { headers });
                const result = await res.json();
                if (result.detail) throw new Error(result.detail);
                if (st) {
                    st.textContent = "Live data: " + Math.round(result.remaining_mb || 0) + " MB remaining";
                    st.style.color = 'var(--ok)';
                }
                setTimeout(fetchOdidoStatus, 1000);
            } catch(e) {
                if (st) {
                    st.textContent = e.message;
                    st.style.color = 'var(--err)';
                }
            }
        }
        
        async function fetchProfiles() {
            try {
                const res = await fetch(API + "/profiles");
                if (res.status === 401) throw new Error("401");
                const data = await res.json();
                const el = document.getElementById('profile-list');
                el.innerHTML = '';
                data.profiles.forEach(p => {
                    const row = document.createElement('div');
                    row.className = 'list-item';

                    const name = document.createElement('span');
                    name.className = 'list-item-text';
                    name.dataset.realName = p;
                    name.textContent = getProfileLabel(p);
                    name.onclick = function() { activateProfile(p); };

                    const delBtn = document.createElement('button');
                    delBtn.className = 'btn btn-icon btn-action';
                    delBtn.title = 'Delete';
                    delBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>';
                    delBtn.onclick = function() { deleteProfile(p); };

                    row.appendChild(name);
                    row.appendChild(delBtn);
                    el.appendChild(row);
                });
                updateProfileListDisplay();
            } catch(e) {}
        }
        async function uploadProfile() {
            const nameInput = document.getElementById('prof-name').value;
            const config = document.getElementById('prof-conf').value;
            const st = document.getElementById('upload-status');
            if(!config) { if(st) st.textContent="Error: Config content missing"; else alert("Error: Config content missing"); return; }
            if(st) st.textContent = "Uploading...";
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (odidoApiKey) headers['X-API-Key'] = odidoApiKey;
                const upRes = await fetch(API + "/upload", { 
                    method:'POST', 
                    headers: headers,
                    body:JSON.stringify({name: nameInput, config: config}) 
                });
                const upData = await upRes.json();
                if(upData.error) throw new Error(upData.error);
                const activeName = upData.name;
                if(st) st.textContent = "Activating " + activeName + "...";
                await fetch(API + "/activate", { 
                    method:'POST', 
                    headers: headers,
                    body:JSON.stringify({name: activeName}) 
                });
                if(st) st.textContent = "Success! VPN restarting."; else alert("Success! VPN restarting.");
                fetchProfiles(); document.getElementById('prof-name').value=""; document.getElementById('prof-conf').value="";
            } catch(e) { if(st) st.textContent = e.message; else alert(e.message); }
        }
        
        async function activateProfile(name) {
            if(!confirm("Switch to " + name + "?")) return;
            try { 
                const headers = { 'Content-Type': 'application/json' };
                if (odidoApiKey) headers['X-API-Key'] = odidoApiKey;
                await fetch(API + "/activate", { 
                    method:'POST', 
                    headers: headers,
                    body:JSON.stringify({name: name}) 
                }); 
                alert("Profile switched. VPN restarting."); 
            } catch(e) { alert("Error"); }
        }
        
        async function deleteProfile(name) {
            if(!confirm("Delete " + name + "?")) return;
            try { 
                const headers = { 'Content-Type': 'application/json' };
                if (odidoApiKey) headers['X-API-Key'] = odidoApiKey;
                await fetch(API + "/delete", { 
                    method:'POST', 
                    headers: headers,
                    body:JSON.stringify({name: name}) 
                }); 
                fetchProfiles(); 
            } catch(e) { alert("Error"); }
        }
        
        function startLogStream() {
            const el = document.getElementById('log-container');
            const status = document.getElementById('log-status');
            const evtSource = new EventSource(API + "/events");
            
            function parseLogLine(line) {
                const div = document.createElement('div');
                div.className = 'log-entry';
                
                let logData = null;
                try {
                    logData = JSON.parse(line);
                } catch(e) {
                    // Fallback for raw lines
                    logData = { message: line, level: 'INFO', category: 'SYSTEM', timestamp: '' };
                }
                
                let icon = 'info';
                let iconColor = 'var(--md-sys-color-primary)';
                let message = logData.message;
                let timestamp = logData.timestamp;

                // Category based icons
                if (logData.category === 'NETWORK') icon = 'lan';
                if (logData.category === 'AUTH' || logData.category === 'SECURITY') icon = 'lock';
                if (logData.category === 'MAINTENANCE') icon = 'build';
                if (logData.category === 'ORCHESTRATION') icon = 'hub';

                // Level based colors
                if (logData.level === 'WARN') {
                    icon = 'warning';
                    iconColor = 'var(--md-sys-color-warning)';
                } else if (logData.level === 'ERROR') {
                    icon = 'error';
                    iconColor = 'var(--md-sys-color-error)';
                } else if (logData.level === 'ACCESS') {
                    icon = 'api';
                    // Simplify common access logs
                    if (message.includes('GET /status')) message = 'Health check processed';
                    if (message.includes('GET /events')) message = 'Log stream connection';
                }

                div.innerHTML = `
                    <span class="material-symbols-rounded log-icon" style="color: ${iconColor}">${icon}</span>
                    <div class="log-content">${message}</div>
                    <span class="log-time">${timestamp}</span>
                `;
                return div;
            }

            evtSource.onmessage = function(e) {
                if (!e.data) return;
                el.appendChild(parseLogLine(e.data));
                if (el.childNodes.length > 500) el.removeChild(el.firstChild);
                el.scrollTop = el.scrollHeight;
            };
            evtSource.onopen = function() { status.textContent = "Live"; status.style.color = "var(--md-sys-color-success)"; };
            evtSource.onerror = function() { status.textContent = "Reconnecting..."; status.style.color = "var(--md-sys-color-error)"; evtSource.close(); setTimeout(startLogStream, 3000); };
        }
        
        function formatBytes(a,b=2){if(!+a)return"0 B";const c=0>b?0:b,d=Math.floor(Math.log(a)/Math.log(1024));return parseFloat((a/Math.pow(1024,d)).toFixed(c)) + " " + ["B","KiB","MiB","GiB","TiB"][d]}
        
        // Snackbar implementation
        const snackbarContainer = document.createElement('div');
        snackbarContainer.className = 'snackbar-container';
        document.body.appendChild(snackbarContainer);

        function showSnackbar(message, actionText = '', actionCallback = null) {
            const snackbar = document.createElement('div');
            snackbar.className = 'snackbar';
            
            let html = `<div class="snackbar-content">${message}</div>`;
            if (actionText) {
                html += `<button class="snackbar-action">${actionText}</button>`;
            }
            snackbar.innerHTML = html;
            
            if (actionCallback) {
                snackbar.querySelector('.snackbar-action').onclick = () => {
                    actionCallback();
                    snackbar.classList.remove('visible');
                    setTimeout(() => snackbar.remove(), 500);
                };
            }

            snackbarContainer.appendChild(snackbar);
            // Trigger reflow
            snackbar.offsetHeight;
            snackbar.classList.add('visible');

            setTimeout(() => {
                snackbar.classList.remove('visible');
                setTimeout(() => snackbar.remove(), 500);
            }, 5000);
        }

        // Theme management
        function toggleTheme() {
            const isLight = document.documentElement.classList.toggle('light-mode');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            updateThemeIcon();
            showSnackbar(`Switched to ${isLight ? 'Light' : 'Dark'} mode`);
        }

        function updateThemeIcon() {
            const icon = document.getElementById('theme-icon');
            const isLight = document.documentElement.classList.contains('light-mode');
            if (icon) icon.textContent = isLight ? 'dark_mode' : 'light_mode';
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersLight = window.matchMedia('(prefers-color-scheme: light)').matches;
            
            if (savedTheme === 'light' || (!savedTheme && systemPrefersLight)) {
                document.documentElement.classList.add('light-mode');
            }
            updateThemeIcon();
        }

        // Privacy toggle functionality
        function togglePrivacy() {
            const toggle = document.getElementById('privacy-switch');
            const body = document.body;
            const isPrivate = toggle.classList.toggle('active');
            if (isPrivate) {
                body.classList.add('privacy-mode');
                localStorage.setItem('privacy_mode', 'true');
            } else {
                body.classList.remove('privacy-mode');
                localStorage.setItem('privacy_mode', 'false');
            }
            updateProfileDisplay();
        }
        
        function initPrivacyMode() {
            const savedMode = localStorage.getItem('privacy_mode');
            if (savedMode === 'true') {
                const toggle = document.getElementById('privacy-switch');
                if (toggle) toggle.classList.add('active');
                document.body.classList.add('privacy-mode');
            }
            updateProfileDisplay();
        }
        
        async function fetchCertStatus() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                const res = await fetch(API + "/certificate-status", { signal: controller.signal });
                clearTimeout(timeoutId);
                
                if (res.status === 401) throw new Error("401");
                const data = await res.json();

                document.getElementById('cert-type').textContent = data.type || "--";
                document.getElementById('cert-subject').textContent = data.subject || "--";
                document.getElementById('cert-issuer').textContent = data.issuer || "--";
                
                // Make the year slightly bolder
                const expiresEl = document.getElementById('cert-to');
                if (data.expires && data.expires !== "--") {
                    const parts = data.expires.split(' ');
                    if (parts.length > 0) {
                        const lastPart = parts[parts.length - 1];
                        const rest = data.expires.substring(0, data.expires.lastIndexOf(lastPart));
                        expiresEl.innerHTML = rest + '<span style="font-weight: 600;">' + lastPart + '</span>';
                    } else {
                        expiresEl.textContent = data.expires;
                    }
                } else {
                    expiresEl.textContent = "--";
                }
                
                const badge = document.getElementById('cert-status-badge');
                const isTrusted = data.status && data.status.includes("Trusted");
                const isSelfSigned = data.status && data.status.includes("Self-Signed");
                const domain = isTrusted ? data.subject : "";

                badge.textContent = data.status || "Unknown";
                
                if (isTrusted) {
                    badge.className = "chip vpn"; // Use primary-container color
                    badge.dataset.tooltip = "✓ Globally Trusted: Valid certificate from Let's Encrypt.";
                } else if (isSelfSigned) {
                    badge.className = "chip admin"; // Use secondary-container color
                    badge.dataset.tooltip = "⚠ Self-Signed (Local): Devices will show security warnings. deSEC configuration recommended.";
                } else {
                    badge.className = "chip tertiary";
                    badge.dataset.tooltip = "Status unknown or certificate missing.";
                }
                
                const failInfo = document.getElementById('ssl-failure-info');
                const trustedInfo = document.getElementById('dns-setup-trusted');
                const untrustedInfo = document.getElementById('dns-setup-untrusted');
                const retryBtn = document.getElementById('ssl-retry-btn');

                if (data.error) {
                    failInfo.style.display = 'block';
                    document.getElementById('ssl-failure-reason').textContent = data.error;
                    if (trustedInfo) trustedInfo.style.display = 'none';
                    if (untrustedInfo) untrustedInfo.style.display = 'block';
                    if (retryBtn) retryBtn.style.display = 'inline-flex';
                    
                    // Trigger wizard only if it failed due to credentials (Auth Error)
                    if (data.status === "Auth Error") {
                        checkWizard(true); // Force wizard if auth failed
                    } else if (data.status === "Rate Limited" || data.status === "Issuance Failed") {
                        // Just alert if rate limited or other non-auth failure
                        showSnackbar("SSL Issue: " + data.error);
                    }
                } else {
                    failInfo.style.display = 'none';
                    if (isTrusted) {
                        if (trustedInfo) trustedInfo.style.display = 'block';
                        if (untrustedInfo) untrustedInfo.style.display = 'none';
                        if (retryBtn) retryBtn.style.display = 'none';
                    } else {
                        if (trustedInfo) trustedInfo.style.display = 'none';
                        if (untrustedInfo) untrustedInfo.style.display = 'block';
                        if (retryBtn) retryBtn.style.display = 'inline-flex';
                    }
                }

                // Automated Link Switching Logic
                const services = {
                    'invidious': { port: '3000', sub: 'invidious' },
                    'redlib': { port: '8080', sub: 'redlib' },
                    'wikiless': { port: '8180', sub: 'wikiless' },
                    'memos': { port: '5230', sub: 'memos' },
                    'rimgo': { port: '3002', sub: 'rimgo' },
                    'scribe': { port: '8280', sub: 'scribe' },
                    'breezewiki': { port: '8380', sub: 'breezewiki' },
                    'anonymousoverflow': { port: '8480', sub: 'anonymousoverflow' },
                    'vert': { port: '5555', sub: 'vert' },
                    'adguard': { port: '8083', sub: 'adguard' },
                    'portainer': { port: '9000', sub: 'portainer' },
                    'wg-easy': { port: '51821', sub: 'wireguard' }
                };

                for (const [id, info] of Object.entries(services)) {
                    const el = document.getElementById('link-' + id);
                    if (!el) continue;
                    if (isTrusted && domain) {
                        el.href = "https://" + info.sub + "." + domain + ":8443/";
                    } else {
                        const baseIpUrl = "http://10.0.1.204:" + info.port;
                        el.href = id === 'breezewiki' ? baseIpUrl + '/' : baseIpUrl;
                    }
                }
                
                // General wizard check after fetching cert status
                checkWizard(false);
            } catch(e) { 
                console.error('Cert status fetch error:', e); 
                const badge = document.getElementById('cert-status-badge');
                if (badge) {
                    badge.textContent = "Fetch Error";
                    badge.dataset.tooltip = "Could not communicate with the backend API.";
                }
            }
        }

        async function requestSslCheck() {
            const btn = document.getElementById('ssl-retry-btn');
            btn.disabled = true;
            btn.style.opacity = '0.5';
            try {
                const res = await fetch(API + "/request-ssl-check");
                const data = await res.json();
                if (data.success) {
                    alert("SSL Check triggered in background. This may take 2-3 minutes. Refresh the dashboard later.");
                } else {
                    alert("Failed to trigger SSL check: " + (data.error || "Unknown error"));
                }
            } catch (e) {
                alert("Network error while triggering SSL check.");
            }
            setTimeout(() => { btn.disabled = false; btn.style.opacity = '1'; }, 10000);
        }

        async function restartStack() {
            if (!confirm("Are you sure you want to restart the entire stack? The dashboard and all services will be unreachable for approximately 30 seconds.")) return;
            
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (odidoApiKey) headers['X-API-Key'] = odidoApiKey;
                const res = await fetch(API + "/restart-stack", {
                    method: 'POST',
                    headers
                });
                
                const data = await res.json();
                if (data.success) {
                    // Show a persistent overlay or alert
                    document.body.innerHTML = `
                        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; background:var(--md-sys-color-surface); color:var(--md-sys-color-on-surface); font-family:sans-serif; text-align:center; padding:24px;">
                            <span class="material-symbols-rounded" style="font-size:64px; color:var(--md-sys-color-primary); margin-bottom:24px;">restart_alt</span>
                            <h1>Restarting Stack...</h1>
                            <p style="margin-top:16px; opacity:0.8;">The management interface is rebooting. This page will automatically refresh when the services are back online.</p>
                            <div style="margin-top:32px; width:48px; height:48px; border:4px solid var(--md-sys-color-surface-container-highest); border-top:4px solid var(--md-sys-color-primary); border-radius:50%; animation: spin 1s linear infinite;"></div>
                            <style>
                                @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                            </style>
                        </div>
                    `;
                    
                    // Poll for availability
                    let attempts = 0;
                    const checkAvailability = setInterval(async () => {
                        attempts++;
                        try {
                            const ping = await fetch(window.location.href, { mode: 'no-cors' });
                            clearInterval(checkAvailability);
                            window.location.reload();
                        } catch (e) {
                            if (attempts > 60) {
                                clearInterval(checkAvailability);
                                alert("Restart is taking longer than expected. Please refresh the page manually.");
                            }
                        }
                    }, 2000);
                } else {
                    throw new Error(data.error || "Unknown error");
                }
            } catch (e) {
                alert("Failed to initiate restart: " + e.message);
            }
        }
        
        // Setup Wizard Logic
        function nextStep(step) {
            document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
            document.getElementById('step-' + step).classList.add('active');
        }

        async function saveWizardDesec() {
            const domain = document.getElementById('wiz-desec-domain').value.trim();
            const token = document.getElementById('wiz-desec-token').value.trim();
            if (!domain || !token) {
                showSnackbar("Both domain and token are required to proceed.");
                return;
            }
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (odidoApiKey) headers['X-API-Key'] = odidoApiKey;
                const res = await fetch(API + "/config-desec", {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ domain, token })
                });
                const result = await res.json();
                if (result.success) {
                    showSnackbar("Configuration saved!");
                    nextStep(3);
                } else { throw new Error(result.error); }
            } catch (e) { showSnackbar("Error: " + e.message); }
        }

        function closeWizard() {
            document.getElementById('setup-wizard').style.display = 'none';
            localStorage.setItem('wizard_completed', 'true');
        }

        function checkWizard(force = false) {
            const completed = localStorage.getItem('wizard_completed');
            const domainPlaceholder = document.getElementById('desec-domain-input').placeholder;
            const hasDomain = domainPlaceholder && domainPlaceholder !== 'yourname.dedyn.io' && domainPlaceholder !== 'Domain (e.g. yourname.dedyn.io)';
            
            if (force) {
                document.getElementById('setup-wizard').style.display = 'flex';
                nextStep(2); // Jump to domain step
                return;
            }

            if (!completed && !hasDomain) {
                document.getElementById('setup-wizard').style.display = 'flex';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Load deSEC config if available
            fetch(API + "/status").then(r => r.json()).then(data => {
                if (data.gluetun && data.gluetun.desec_domain) {
                    document.getElementById('desec-domain-input').placeholder = data.gluetun.desec_domain;
                }
                // checkWizard will be called by fetchCertStatus to ensure it has latest SSL info
            }).catch(() => { checkWizard(); });

            // Tooltip Initialization
            const tooltipBox = document.createElement('div');
            tooltipBox.className = 'tooltip-box';
            document.body.appendChild(tooltipBox);

            document.addEventListener('mouseover', (e) => {
                const target = e.target.closest('[data-tooltip]');
                if (!target) return;

                tooltipBox.textContent = target.dataset.tooltip;
                tooltipBox.style.display = 'block';
                // Trigger reflow
                tooltipBox.offsetHeight;
                tooltipBox.classList.add('visible');

                const rect = target.getBoundingClientRect();
                const boxRect = tooltipBox.getBoundingClientRect();
                
                let top = rect.top - boxRect.height - 12;
                let left = rect.left + (rect.width / 2) - (boxRect.width / 2);

                // Edge collision detection (with 12px safety margin)
                if (top < 12) top = rect.bottom + 12;
                if (left < 12) left = 12;
                if (left + boxRect.width > window.innerWidth - 12) {
                    left = window.innerWidth - boxRect.width - 12;
                }
                
                // Final safety: ensure it doesn't go off bottom
                if (top + boxRect.height > window.innerHeight - 12) {
                    top = window.innerHeight - boxRect.height - 12;
                }

                tooltipBox.style.top = top + 'px';
                tooltipBox.style.left = left + 'px';
            });

            document.addEventListener('mouseout', (e) => {
                if (e.target.closest('[data-tooltip]')) {
                    tooltipBox.classList.remove('visible');
                    // Hide after transition
                    setTimeout(() => {
                        if (!tooltipBox.classList.contains('visible')) {
                            tooltipBox.style.display = 'none';
                        }
                    }, 150);
                }
            });

            // Pre-populate Odido API key from deployment
            if (DEFAULT_ODIDO_API_KEY && !localStorage.getItem('odido_api_key')) {
                localStorage.setItem('odido_api_key', DEFAULT_ODIDO_API_KEY);
                odidoApiKey = DEFAULT_ODIDO_API_KEY;
            }
            // Pre-populate the API key input field so users can see their dashboard API key
            const apiKeyInput = document.getElementById('odido-api-key');
            if (apiKeyInput && odidoApiKey) {
                apiKeyInput.value = odidoApiKey;
            }
            
            initPrivacyMode();
            initTheme();
            fetchContainerIds();
            fetchStatus(); fetchProfiles(); fetchOdidoStatus(); fetchCertStatus(); startLogStream(); fetchUpdates(); fetchMetrics();
            setInterval(fetchStatus, 15000);
            setInterval(fetchMetrics, 30000);
            setInterval(fetchUpdates, 300000); // Check for source updates every 5 mins
            setInterval(fetchOdidoStatus, 60000);  // Reduced polling frequency to respect Odido API
            setInterval(fetchContainerIds, 60000);
        });
    </script>
</body>
</html>
