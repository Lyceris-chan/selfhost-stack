# Privacy Hub Configuration Reference

> **Complete transparency documentation for all configuration changes**
> 
> This document details every setting modified by the Privacy Hub, where it's changed, and why. Perfect for understanding exactly what the system does to your infrastructure.

## Quick Reference Table

| Service | Config File | Modified By | Key Changes |
|---------|-------------|-------------|-------------|
| AdGuard Home | `AdGuardHome.yaml` | `lib/services/config.sh` | Upstream DNS, TLS, filtering |
| Unbound | `unbound.conf` | `lib/services/config.sh` | DNSSEC, privacy, caching |
| Gluetun | Environment vars | `lib/services/compose.sh` | VPN provider, firewall |
| WG-Easy | Environment vars | `lib/services/compose.sh` | Server endpoint, DNS |
| Nginx | `nginx.conf` | `lib/services/config.sh` | HTTPS, reverse proxy |
| Certificates | `ssl.crt/key` | `lib/services/config.sh` | Let's Encrypt automation |

---

## AdGuard Home Configuration

**Config File**: `${DATA_DIR}/adguard/conf/AdGuardHome.yaml`  
**Modified By**: `lib/services/config.sh` → `setup_adguard_config()`

### Upstream DNS → Unbound
```yaml
dns:
  upstream_dns:
    - 127.0.0.1:5335
```
**Why**: Routes all DNS queries through Unbound for DNSSEC validation without third-party resolvers.

### Encrypted DNS Protocols
```yaml
tls:
  enabled: true
  server_name: ${DESEC_DOMAIN}
  port_dns_over_tls: 853
  port_dns_over_quic: 853
```
**Why**: Enables DoT/DoH/DoQ for encrypted DNS on mobile devices.

### Query Logging
```yaml
querylog:
  enabled: true
  interval: 24h
```
**Why**: Enables troubleshooting while limiting log retention to 24 hours for privacy.

---

## Unbound Configuration

**Config File**: `${DATA_DIR}/unbound/unbound.conf`  
**Modified By**: `lib/services/config.sh` → `setup_unbound_config()`

### DNSSEC Validation
```conf
module-config: "validator iterator"
auto-trust-anchor-file: "/opt/unbound/etc/unbound/root.key"
```
**Why**: Validates DNS responses cryptographically to prevent spoofing.

### Privacy Protection
```conf
hide-identity: yes
hide-version: yes
qname-minimisation: yes
```
**Why**: Minimizes information leakage to upstream DNS servers (RFC 7816).

### Performance Tuning
```conf
msg-cache-size: 128m
rrset-cache-size: 256m
prefetch: yes
```
**Why**: Aggressive caching reduces query latency and upstream traffic.

---

## Gluetun VPN Configuration

**Configuration**: Docker Compose environment variables  
**Modified By**: `lib/services/compose.sh` → `generate_gluetun_service()`

### Control Server API
```yaml
environment:
  - HTTPPROXY=on
  - HTTPPROXY_USER=gluetun
  - HTTPPROXY_PASSWORD=${ADMIN_PASSWORD}
```
**Why**: Enables HTTP API for status monitoring and management from dashboard.

### Firewall Rules
```yaml
environment:
  - FIREWALL_OUTBOUND_SUBNETS=${LAN_SUBNET}
```
**Why**: Allows LAN access while forcing all internet traffic through VPN.

### Health Check
```yaml
healthcheck:
  test: ["CMD", "wget", "--spider", "-q", "https://www.cloudflare.com"]
  interval: 30s
```
**Why**: Verifies VPN tunnel is active by testing external connectivity.

---

## WG-Easy Configuration

**Configuration**: Docker Compose environment variables  
**Modified By**: `lib/services/compose.sh` → `generate_wgeasy_service()`

### Server Endpoint
```yaml
environment:
  - WG_HOST=${DESEC_DOMAIN:-${LAN_IP}}
  - WG_PORT=51820
```
**Why**: Configures the hostname/IP clients connect to. Prefers domain if configured.

### DNS Configuration
```yaml
environment:
  - WG_DEFAULT_DNS=${LAN_IP}
```
**Why**: Connected clients use Privacy Hub's DNS server automatically.

### Full Tunnel Mode
```yaml
environment:
  - WG_ALLOWED_IPS=0.0.0.0/0,::/0
```
**Why**: Routes all client traffic through the tunnel for complete privacy.

---

## Certificate Management

**Script**: `${DATA_DIR}/cert_monitor.sh`  
**Generated By**: `lib/services/config.sh` → `setup_ssl_certificates()`

### Let's Encrypt via acme.sh
```bash
acme.sh --issue --dns dns_desec --dnssleep 15 \
  -d "${DESEC_DOMAIN}" -d "*.${DESEC_DOMAIN}" \
  --server letsencrypt
```
**Why**: Obtains wildcard certificates via DNS-01 challenge (no port 80/443 exposure).

### Certificate Storage
- **Source**: `${AGH_CONF_DIR}/certs/${DESEC_DOMAIN}_ecc/fullchain.cer`
- **Deployed To**: 
  - `${AGH_CONF_DIR}/ssl.crt` (AdGuard Home)
  - `${DATA_DIR}/dashboard/ssl.crt` (Nginx)

### Automatic Renewal
**Cron Schedule**: Daily at 2 AM
```bash
acme.sh --cron --home /acme
```
**Why**: Certificates expire after 90 days and must be renewed automatically.

---

## Container Security Hardening

**Modified By**: `lib/services/compose.sh`

### Read-Only Filesystem
```yaml
read_only: true
security_opt:
  - no-new-privileges:true
```
**Applied To**: Dashboard, Nginx, Unbound, Redis  
**Why**: Prevents tampering with container filesystem.

### Capability Dropping
```yaml
cap_drop:
  - ALL
```
**Applied To**: All containers  
**Why**: Removes unnecessary Linux capabilities to minimize attack surface.

### Network Isolation
```yaml
network_mode: "container:${CONTAINER_PREFIX}gluetun"
```
**Applied To**: qBittorrent, Transmission, Sonarr, Radarr, Prowlarr  
**Why**: Forces these services to use VPN tunnel by sharing gluetun's network.

---

## Environment Variables Reference

**File**: `.secrets` (auto-generated)

```bash
# Network
LAN_IP=192.168.1.100          # Auto-detected host IP
LAN_SUBNET=192.168.1.0/24     # Auto-detected subnet

# Security (auto-generated, 32-character random)
ADMIN_PASSWORD=<random>        # Dashboard & service admin password
HUB_API_KEY=<random>          # API authentication token

# Optional DNS & SSL
DESEC_DOMAIN=                  # Your deSEC domain (e.g., myname.dedyn.io)
DESEC_TOKEN=                   # deSEC API token

# Ports (customizable via flags)
PORT_DASHBOARD_WEB=8080        # HTTP dashboard
PORT_DASHBOARD_HTTPS=8443      # HTTPS dashboard
PORT_ADGUARD=3000              # AdGuard Home UI
PORT_WGEASY=51821              # WG-Easy UI

# Paths
BASE_DIR=/opt/privacy-hub      # Installation root
DATA_DIR=${BASE_DIR}/data      # Persistent data storage
```

**Modified By**: `zima.sh` during initial setup, `lib/core/constants.sh` for defaults.

---

## Verification Commands

### Check AdGuard Configuration
```bash
docker exec privacy-hub-adguard cat /opt/adguardhome/conf/AdGuardHome.yaml | grep -A5 upstream_dns
```

### Check Unbound DNSSEC
```bash
docker exec privacy-hub-unbound unbound-checkconf /opt/unbound/etc/unbound/unbound.conf
```

### Verify Certificate
```bash
openssl x509 -in ${DATA_DIR}/adguard/conf/ssl.crt -text -noout | grep -E "Issuer|Subject|Not After"
```

### Check Container Security
```bash
docker inspect privacy-hub-adguard | jq '.[0].HostConfig.ReadonlyRootfs'
```

### Test VPN Tunnel
```bash
docker exec privacy-hub-gluetun wget -qO- https://api.ipify.org
```

---

**Document Version**: 1.0.0  
**Last Updated**: 2026-01-16  
**Maintained By**: Privacy Hub Project
